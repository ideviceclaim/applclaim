<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate PDF - Shiraz Store</title>
    <script src="libs/jspdf.umd.min.js"></script>
    <script src="libs/html2canvas.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f7f7f8;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 26px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.04);
        }
        .preview-area {
            border: 2px solid #e6e6e8;
            padding: 20px;
            background: white;
            margin: 20px 0;
            min-height: 400px;
            border-radius: 10px;
        }
        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            font-weight: 800;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-success {
            background: #059669;
        }
        .btn-success:hover {
            background: #047857;
        }
        .status-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #0071e3;
            font-size: 14px;
        }
        h1 {
            color: #0071e3;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÑ Generate PDF Document</h1>
        
        <div class="status-info">
            <strong>Customer:</strong> <span id="customerName">Loading...</span> | 
            <strong>Claim ID:</strong> <span id="claimId">Loading...</span> |
            <strong>Product:</strong> <span id="productName">Loading...</span>
        </div>
        
        <p>Click the button below to generate and download your iDevice Claim PDF.</p>
        
        <div id="preview" class="preview-area">
            <div class="loading">Loading preview...</div>
        </div>
        
        <div>
            <button onclick="generatePDF()" class="btn-success">üìÑ Download PDF</button>
            <button onclick="window.print()" class="btn-secondary">üñ®Ô∏è Print</button>
            <button onclick="window.close()" class="btn-secondary">‚ùå Close</button>
        </div>
        
        <p style="color: #6b7280; margin-top: 20px; font-size: 13px;">
            The PDF will be generated in A4 format. You can also use the browser's print function (Ctrl+P) and select "Save as PDF".
        </p>
    </div>

    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const data = {
            name: decodeURIComponent(urlParams.get('name') || 'AHMAD LUQMAN HAKIM BIN ROSIDI'),
            email: decodeURIComponent(urlParams.get('email') || 'luq2208@gmail.com'),
            phone: decodeURIComponent(urlParams.get('phone') || '0139062991'),
            address: decodeURIComponent(urlParams.get('address') || 'KAMPUNG BUKIT MAK LIPAH MAHLIGAI 16400 MELOR KELANTAN'),
            product: urlParams.get('product') || 'iphone15',
            color: decodeURIComponent(urlParams.get('color') || 'On admin activation'),
            storage: decodeURIComponent(urlParams.get('storage') || 'On admin activation'),
            qty: urlParams.get('qty') || '1',
            claimId: decodeURIComponent(urlParams.get('claimId') || 'SHZ025-2991')
        };

        // Updated image URLs to match your main app structure
        const PRODUCTS = {
            iphone15: {
                title: 'iPhone 15 Pro Max',
                price: '{Sponsored}',
                color: 'On admin activation',
                storage: 'On admin activation',
                description: `Premium smartphone with A17 Pro chip, ProMotion display, titanium design, and professional camera system. Features 48MP main camera, Action mode, and all-day battery life.`,
                image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_iphone15promax.jpg'
            },
            iphone14: {
                title: 'iPhone 14 Pro Max',
                price: '{Sponsored}',
                color: 'On admin activation',
                storage: 'On admin activation',
                description: `iPhone 14 Pro Max: Powerful and Pro-Grade. Featuring the groundbreaking 48MP Main camera and Dynamic Island. Powered by A16 Bionic. Includes a one-year limited warranty.`,
                image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_iphone14promax.jpg'
            },
            ipadair: {
                title: '13-inch iPad Air with M3',
                price: '{Sponsored}',
                color: 'On admin activation',
                storage: 'On admin activation',
                description: `13-inch iPad Air with M3: Big on Power, Ready for Anything. Includes a 20W USB-C adapter and a one-year limited warranty.`,
                image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_13inchiPad.jpg'
            },
            macbook15: {
                title: '15-inch MacBook Air with M3',
                price: '{Sponsored}',
                color: 'On admin activation',
                storage: 'On admin activation',
                description: `15-inch MacBook Air with M3: Big Screen. Blazing Fast. Includes a 35W power adapter and a one-year limited warranty.`,
                image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_15inchMacBook.jpg'
            }
        };

        function getProductTitle(productKey) {
            return PRODUCTS[productKey]?.title || 'Unknown Product';
        }

        // Update status info display
        document.getElementById('customerName').textContent = data.name.split(' ')[0] || 'Customer';
        document.getElementById('claimId').textContent = data.claimId || 'N/A';
        document.getElementById('productName').textContent = getProductTitle(data.product);

        // Build the A4 HTML content - MATCHING YOUR MAIN APP'S LATEST DESIGN
        function buildA4Content() {
            const product = PRODUCTS[data.product];
            const dateTime = new Date().toLocaleString();
            const logoUrl = 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/Shiraz.jpg';

            return `
                <div style="width:21cm; min-height:29.7cm; background:white; padding:1.5cm; margin:0 auto; font-family:Arial,sans-serif; position:relative;">
                    <div style="display:flex; align-items:center; gap:14px; margin-bottom:20px; border-bottom:2px solid #e0e0e0; padding-bottom:15px;">
                        <img src="${logoUrl}" alt="Shiraz Logo" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">
                        <div style="flex:1">
                            <div style="display:flex;align-items:center;justify-content:space-between">
                                <div>
                                    <div style="color:#0071e3;font-size:18px;font-weight:700;line-height:1.2;">SHIRAZ APPLE STORE ‚Äì IDEVICE ACTIVATION PORTAL</div>
                                    <div style="color:#6b7280;font-size:13px;margin-top:4px;">Claim summary & activation document</div>
                                </div>
                                <div style="text-align:left;color:#6b7280;font-size:13px">Status:<br><strong style="color:#059669;font-size:13px;">‚úÖ APPROVED</strong></div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align:right;margin-bottom:20px;font-size:13px;color:#6d6d6f;">${dateTime}</div>

                    <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                        <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">CUSTOMER INFORMATION</h2>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;font-size:14px;line-height:1.5;">
                            <div style="display:flex;flex-direction:column;gap:15px;justify-content:space-between;margin:20px 0;gap:15px;font-size:14px;">

                <div><strong style="color:#424245;">Full Name:</strong><br><span style="color:#1d1d1f;">${data.name}</span></div>
                                <div><strong style="color:#424245;">Claim ID:</strong><br><span style="color:#1d1d1f;font-weight:600;">${data.claimId}</span></div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:15px;justify-content:space-between;margin:20px 0;gap:15px;font-size:14px;">
                                <div><strong style="color:#424245;">Email:</strong><br><span style="color:#1d1d1f;">${data.email}</span></div>
                                <div><strong style="color:#424245;">Phone:</strong><br><span style="color:#1d1d1f;">${data.phone}</span></div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                        <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">DELIVERY ADDRESS</h2>
                        <div style="white-space: pre-line;font-size:14px;line-height:1.5;color:#1d1d1f;">${data.address}</div>
                    </div>

                    <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                        <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">DEVICE MODEL</h2>
                        <div style="font-size:17px;color:#1d1d1f;margin-bottom:12px;font-weight:600;">${product.title}</div>
                        
                        <div style="display:flex;gap:20px;margin:15px 0;padding:15px;background:white;border-radius:8px;border:1px solid #e0e0e0;">
                            <img src="${product.image}" alt="${product.title}" style="width:180px;height:140px;object-fit:cover;border-radius:8px;">
                            <div style="flex:1">
                                <div style="font-size:14px;color:#6d6d6f;margin-bottom:12px;line-height:1.5;">${product.description}</div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;line-height:1.6;">
                                    <div><strong style="color:#424245;">Color:</strong> <span style="color:#1d1d1f;">${data.color || product.color}</span></div>
                                    <div><strong style="color:#424245;">Storage:</strong> <span style="color:#1d1d1f;">${data.storage || product.storage}</span></div>
                                    <div><strong style="color:#424245;">Price:</strong> <span style="color:#1d1d1f;">${product.price}</span></div>
                                    <div><strong style="color:#424245;">Quantity:</strong> <span style="color:#1d1d1f;">${data.qty}</span></div>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex;justify-content:space-between;margin:20px 0;gap:10px;">
                            <div style="flex:1;text-align:center;padding:12px;background:#f3f4f6;border-radius:6px;border:2px solid #d1d5db;font-size:14px;color:#424245;font-weight:600;">256GB</div>
                            <div style="flex:1;text-align:center;padding:12px;background:#d1fae5;border-radius:6px;border:2px solid #a7f3d0;font-size:14px;color:#065f46;font-weight:600;">512GB</div>
                            <div style="flex:1;text-align:center;padding:12px;background:#fed7aa;border-radius:6px;border:2px solid #fdba74;font-size:14px;color:#7c2d12;font-weight:600;">1TB</div>
                        </div>
                    </div>

                    <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                        <h2 style="font-size:16px;margin-bottom:8px;color:#1d1d1f;font-weight:600;">NEXT STEP</h2>
                        <div style="font-size:14px;color:#1d1d1f;line-height:1.6;">
                            <p style="margin:0 0 12px 0;">
                                <strong>To complete activation and schedule delivery:</strong>
                            </p>
                            <ul style="margin:0;padding-left:20px;">
                                <li>Write down your Claim ID</li>
                                <li>Choose color and storage capacity</li>
                                <li>Complete the iDevice activation process</li>
                                <li>Schedule delivery (typically 3‚Äì5 business days)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div style="background:#ffffff;padding:15px;text-align:center;border-radius:0 0 8px 8px;font-size:13px;color:#6d6d6f;border-top:1px solid #e5e5e5;">
                        ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>
                        (873719-X) Copyright ¬©2025<br><br>
                        <a href="https://activate.apple.com" target="_blank" style="color:#0071e3;text-decoration:none;font-size:12px;">
                            https://activate.apple.com</a>
                    </div>
                </div>
            `;
        }

        // Display preview
        function displayPreview() {
            const preview = document.getElementById('preview');
            preview.innerHTML = buildA4Content();
        }

        // Generate PDF
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            try {
                // Show loading state
                const preview = document.getElementById('preview');
                const originalHTML = preview.innerHTML;
                preview.innerHTML = '<div class="loading">Generating PDF... Please wait</div>';
                
                // Create a temporary div for PDF generation
                const tempDiv = document.createElement('div');
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                tempDiv.style.top = '0';
                tempDiv.style.width = '794px'; // A4 width in pixels for 96 DPI
                tempDiv.style.background = 'white';
                tempDiv.innerHTML = buildA4Content();
                document.body.appendChild(tempDiv);

                const canvas = await html2canvas(tempDiv, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: false,
                    logging: false
                });

                // Clean up
                document.body.removeChild(tempDiv);
                preview.innerHTML = originalHTML;

                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                
                const fileName = `iDevice_Claim_${data.claimId || 'document'}.pdf`;
                pdf.save(fileName);
                
                alert(`‚úÖ PDF successfully generated: ${fileName}`);
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('‚ùå PDF generation failed. Please use the Print button instead and select "Save as PDF".');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            displayPreview();
        });
    </script>
</body>
</html>
