<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Shiraz Store — Checkout & PDF/Email Generator</title>
<style>
  :root{ --primary:#0071e3; --muted:#6b7280; --bg:#f7f7f8; --card:#fff; }
  *{box-sizing:border-box}
  body{margin:0;padding:18px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:#111}
  .container{max-width:1100px;margin:0 auto}
  .header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
  .logo{width:30px;height:30px;object-fit:cover;border-radius:4px}
  .title{margin:0;color:var(--primary);font-size:18px;font-weight:700}
  .subtitle{margin:0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 480px;gap:16px}
  @media(max-width:1000px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 26px rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.04)}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type=text], input[type=email], input[type=number], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e8;background:#fff;font-size:15px}
  textarea{min-height:80px}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{padding:10px 12px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
  .btn-plain{background:#374151;color:#fff}
  .btn-print{background:#059669;color:#fff}
  .btn-pdf{background:#dc2626;color:#fff}
  .preview{min-height:520px;border-radius:10px;border:2px solid #e6e6e8;padding:10px;background:#fff;overflow:auto;position:relative}
  .small{font-size:13px;color:var(--muted)}
  .watermark{position:absolute;opacity:0.07;pointer-events:none;transform:rotate(-20deg);right:-20px;bottom:80px;width:60%}
  .footer-note{font-size:13px;color:var(--muted);margin-top:10px}
  .toast{position:fixed;right:18px;top:18px;padding:10px 14px;border-radius:8px;color:white;display:none;z-index:9999}
  .email-preview{min-height:520px;border-radius:10px;border:2px solid #e6e6e8;padding:10px;background:#fff;overflow:auto}
  
  .print-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); display: none; justify-content: center; 
    align-items: center; z-index: 10000;
  }
  .print-modal-content {
    background: white; padding: 20px; border-radius: 12px;
    max-width: 90%; max-height: 90%; overflow: auto; position: relative;
  }
  .print-modal-close {
    position: absolute; top: 10px; right: 10px;
    background: #dc2626; color: white; border: none;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
  }

  /* Admin Section Styles */
  .admin-section {
    margin-top: 12px;
    display: none;
  }
  .admin-toggle {
    background: #f97316;
    color: white;
    margin-top: 12px;
    width: 100%;
  }
  .admin-panel {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-top: 12px;
  }
  .admin-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  .admin-tab {
    padding: 8px 16px;
    cursor: pointer;
    border: none;
    background: transparent;
    border-bottom: 2px solid transparent;
  }
  .admin-tab.active {
    border-bottom: 2px solid var(--primary);
    color: var(--primary);
    font-weight: 600;
  }
  .admin-content {
    display: none;
  }
  .admin-content.active {
    display: block;
  }
  .tracking-update {
    background: #e7f3ff;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
  }
  .tracking-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }
  .tracking-row input, .tracking-row select {
    flex: 1;
  }
  .tracking-history {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    background: white;
  }
  .tracking-item {
    padding: 8px;
    border-bottom: 1px solid #f1f3f4;
    display: flex;
    justify-content: space-between;
  }
  .tracking-item:last-child {
    border-bottom: none;
  }
  .tracking-actions {
    display: flex;
    gap: 5px;
  }
  .btn-small {
    padding: 4px 8px;
    font-size: 12px;
  }
  .btn-danger {
    background: #dc2626;
    color: white;
  }
  .delivery-email-preview {
    min-height: 300px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    background: white;
    overflow: auto;
  }
  .user-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    background: white;
  }
  .user-item {
    padding: 10px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
  }
  .user-item:hover {
    background: #f8f9fa;
  }
  .user-item:last-child {
    border-bottom: none;
  }
  .json-output {
    font-family: monospace;
    font-size: 12px;
    white-space: pre-wrap;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    max-height: 400px;
    overflow-y: auto;
  }

  /* Enhanced Admin Styles */
  .admin-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 15px;
  }
  .admin-stat-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .admin-stat-number {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .admin-stat-label {
    font-size: 12px;
    color: var(--muted);
  }
  .admin-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  .admin-table th {
    background: var(--primary);
    color: white;
    padding: 10px;
    text-align: left;
    font-weight: 600;
  }
  .admin-table td {
    padding: 10px;
    border-bottom: 1px solid #e9ecef;
  }
  .admin-table tr:hover {
    background: #f8f9fa;
  }
  .status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  .status-delivered {
    background-color: #d4edda;
    color: #155724;
  }
  .status-transit {
    background-color: #cce7ff;
    color: #004085;
  }
  .status-pending {
    background-color: #fff3cd;
    color: #856404;
  }
  .status-out {
    background-color: #f8d7da;
    color: #721c24;
  }
  .search-highlight {
    background-color: #fff3cd;
    padding: 0 2px;
    border-radius: 2px;
  }

  /* Enhanced Admin Dashboard */
  .admin-dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .dashboard-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .dashboard-card h5 {
    margin: 0 0 10px 0;
    color: var(--primary);
    font-size: 14px;
  }
  
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  
  .quick-action-btn {
    padding: 8px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    text-align: center;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }
  
  .quick-action-btn:hover {
    background: #e9ecef;
    border-color: #0071e3;
  }
  
  .recent-activity {
    max-height: 200px;
    overflow-y: auto;
  }
  
  .activity-item {
    padding: 8px;
    border-bottom: 1px solid #f1f3f4;
    font-size: 12px;
  }
  
  .activity-item:last-child {
    border-bottom: none;
  }
  
  .activity-time {
    color: var(--muted);
    font-size: 11px;
  }
  
  /* Modal enhancements */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    justify-content: center;
    align-items: center;
  }
  
  .modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    max-width: 90%;
    max-height: 90%;
    overflow: auto;
    position: relative;
  }
  
  .modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #dc2626;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
  }
  
  /* Timeline styles for tracking history */
  .timeline {
    position: relative;
    padding-left: 20px;
  }
  
  .timeline::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e0e0e0;
  }
  
  .timeline-item {
    position: relative;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f1f3f4;
  }
  
  .timeline-item:last-child {
    border-bottom: none;
  }
  
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -25px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary);
    border: 2px solid white;
    box-shadow: 0 0 0 2px var(--primary);
  }
  
  .timeline-status {
    font-weight: 600;
    color: var(--dark);
  }
  
  .timeline-location {
    color: var(--muted);
    font-size: 12px;
  }
  
  .timeline-time {
    color: var(--muted);
    font-size: 11px;
  }
  
  /* Enhanced table styles */
  .table-actions {
    display: flex;
    gap: 5px;
    justify-content: center;
  }
  
  .btn-icon {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }
  
  .btn-edit {
    background: #ffc107;
    color: white;
  }
  
  .btn-delete {
    background: #dc3545;
    color: white;
  }
  
  .btn-view {
    background: #17a2b8;
    color: white;
  }
  
  /* Status indicator styles */
  .status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
  }
  
  .status-indicator.delivered {
    background: #28a745;
  }
  
  .status-indicator.transit {
    background: #007bff;
  }
  
  .status-indicator.pending {
    background: #ffc107;
  }
  
  .status-indicator.delayed {
    background: #dc3545;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <img id="hdrLogo" class="logo" src="assets/Shiraz.jpg" alt="Shiraz Logo">
    <div style="flex:1">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="title">SHIRAZ APPLE – IDEVICE CLAIM</div>
          <div class="subtitle">summary</div>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:12px">Status: <strong style="color:#059669">✅ APPROVED</strong></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3 style="margin:0 0 8px 0">Customer & Product</h3>
        <div style="margin-top:10px"><label for="name">Full Name</label><input id="name" type="text" value="AHMAD LUQMAN HAKIM BIN ROSIDI"></div>
        <div class="row" style="margin-top:10px">
          <div><label for="email">Email</label><input id="email" type="email" value="luq2208@gmail.com"></div>
          <div><label for="phone">Phone Number</label><input id="phone" type="text" value="0139062991" maxlength="18"></div>
        </div>
        <div style="margin-top:10px"><label for="address">Delivery Address</label><textarea id="address">KAMPUNG BUKIT MAK LIPAH MAHLIGAI 16400 MELOR KELANTAN</textarea></div>
        <div class="row" style="margin-top:10px">
          <div><label for="product">iDevice</label>
            <select id="product">
              <option value="iphone15">Apple iPhone 15 Pro Max</option>
              <option value="iphone14">Apple iPhone 14 Pro Max</option>
              <option value="ipadair">13-inch iPad Air with M3</option>
              <option value="macbook15">15-inch MacBook Air with M3</option>
            </select>
          </div>
          <div><label for="color">Color (Admin)</label><input id="color" type="text" value="On admin activation" disabled></div>
          <div><label for="storage">Storage (Admin)</label><input id="storage" type="text" value="On admin activation" disabled></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div><label>Claim ID (auto)</label><input id="claim" type="text" readonly></div>
          <div><label>Qty</label><input id="qty" type="number" min="1" value="1"></div>
        </div>

        <div style="margin-top:12px" class="btns">
          <button class="btn-primary" onclick="generateSummary()">Generate Summary</button>
          <button class="btn-pdf" onclick="downloadPDF()">📄 Download PDF</button>
          <button class="btn-print" onclick="openPrintModal()">🖨️ Print Preview</button>
          <button class="btn-plain" onclick="resetForm()">Reset</button>
          <button class="btn-success" onclick="saveClaimToUserData()" style="background:#059669;color:white">Save Claim</button>
        </div>
        <p class="footer-note">Claim ID format: <code>SHZ025-{last4digitsOfPhone}</code></p>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px 0">Quick Select</h4>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('iphone15')"><strong>iPhone 15 Pro Max</strong><div class="small muted">Sponsored</div></div>
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('iphone14')"><strong>iPhone 14 Pro Max</strong><div class="small muted">Sponsored</div></div>
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('ipadair')"><strong>13-inch iPad Air</strong><div class="small muted">Sponsored</div></div>
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('macbook15')"><strong>15-inch MacBook Air</strong><div class="small muted">Sponsored</div></div>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h4 style="margin:0 0 8px 0">A4 PDF Preview (single page)</h4>
        <div id="preview" class="preview">
          <div style="text-align:center;padding:40px;color:#888">No summary yet — click <strong>Generate Summary</strong></div>
          <img id="wm" class="watermark" src="" style="display:none" alt="watermark">
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="btn-primary" onclick="copyEmailHtml()">Copy Email HTML</button>
          <button class="btn-outline" onclick="openMail()">Open Mail</button>
          <button class="btn-outline" onclick="downloadEML()">Download .eml</button>
          <button class="btn-print" onclick="openPrintModal()">🖨️ Print Preview</button>
        </div>
        <p class="footer-note">After copying: open Mail/Outlook and paste into body.</p>
      </div>

      <!-- Enhanced Admin Management Section -->
      <div class="card admin-section" id="adminSection">
        <h4 style="margin:0 0 8px 0">Admin Management</h4>
        
        <!-- Admin Stats -->
        <div class="admin-stats">
          <div class="admin-stat-card">
            <div class="admin-stat-number" id="totalShipments">0</div>
            <div class="admin-stat-label">Total Shipments</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-number" id="inTransitShipments">0</div>
            <div class="admin-stat-label">In Transit</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-number" id="deliveredShipments">0</div>
            <div class="admin-stat-label">Delivered</div>
          </div>
          <div class="admin-stat-card">
            <div class="admin-stat-number" id="pendingShipments">0</div>
            <div class="admin-stat-label">Pending</div>
          </div>
        </div>
        
        <!-- Enhanced Admin Dashboard -->
        <div class="admin-dashboard">
          <div class="dashboard-card">
            <h5>📊 Quick Stats</h5>
            <div class="admin-stats">
              <div class="admin-stat-card">
                <div class="admin-stat-number" id="totalShipments2">0</div>
                <div class="admin-stat-label">Total Shipments</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-number" id="inTransitShipments2">0</div>
                <div class="admin-stat-label">In Transit</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-number" id="deliveredShipments2">0</div>
                <div class="admin-stat-label">Delivered</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-number" id="pendingShipments2">0</div>
                <div class="admin-stat-label">Pending</div>
              </div>
            </div>
          </div>
          
          <div class="dashboard-card">
            <h5>⚡ Quick Actions</h5>
            <div class="quick-actions">
              <div class="quick-action-btn" onclick="showAddShipmentForm()">
                <div>➕ Add Shipment</div>
              </div>
              <div class="quick-action-btn" onclick="showModal('bulkImportModal')">
                <div>📥 Bulk Import</div>
              </div>
              <div class="quick-action-btn" onclick="exportJSON()">
                <div>📤 Export JSON</div>
              </div>
              <div class="quick-action-btn" onclick="showModal('settingsModal')">
                <div>⚙️ Settings</div>
              </div>
            </div>
          </div>
          
          <div class="dashboard-card">
            <h5>🔍 Search & Filters</h5>
            <div class="tracking-row">
              <input type="text" id="searchInput" placeholder="Search by name, phone, or tracking..." style="flex:2">
              <select id="statusFilter" onchange="renderShipmentTable()">
                <option value="">All Statuses</option>
                <option value="In Transit">In Transit</option>
                <option value="Delivered">Delivered</option>
                <option value="Pending">Pending</option>
                <option value="Out for Delivery">Out for Delivery</option>
              </select>
            </div>
          </div>
          
          <div class="dashboard-card">
            <h5>📋 Recent Activity</h5>
            <div id="recentActivity" class="recent-activity">
              <div class="activity-item">No recent activity</div>
            </div>
          </div>
        </div>
        
        <div class="admin-tabs">
          <button class="admin-tab active" onclick="switchAdminTab('shipmentManagement')">📦 Shipment Management</button>
          <button class="admin-tab" onclick="switchAdminTab('emailManagement')">✉️ Email Management</button>
          <button class="admin-tab" onclick="switchAdminTab('jsonOutput')">🔧 JSON Output</button>
        </div>
        
        <!-- Shipment Management Tab -->
        <div id="shipmentManagement" class="admin-content active">
          <h5 style="margin:0 0 10px 0">Shipment List</h5>
          
          <div class="table-container" style="margin-top:10px">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Tracking #</th>
                  <th>Receiver Name</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Service</th>
                  <th>Est. Delivery</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="shipmentTableBody"></tbody>
            </table>
          </div>
          
          <!-- Add/Edit Shipment Form -->
          <div id="shipmentForm" class="tracking-update" style="display:none; margin-top:10px">
            <h5 style="margin:0 0 10px 0" id="shipmentFormTitle">Add New Shipment</h5>
            <input type="hidden" id="shipmentTracking">
            
            <div class="tracking-row">
              <select id="shipmentStatus">
                <option value="In Transit">In Transit</option>
                <option value="Delivered">Delivered</option>
                <option value="Pending">Pending</option>
                <option value="Out for Delivery">Out for Delivery</option>
                <option value="Picked up">Picked up</option>
                <option value="Arrived at facility">Arrived at facility</option>
              </select>
              <input id="shipmentService" type="text" placeholder="Service (e.g., DHL Express)">
            </div>
            
            <div class="tracking-row">
              <input id="shipmentEstDelivery" type="date" placeholder="Est. Delivery">
              <input id="shipmentWeight" type="text" placeholder="Weight">
            </div>
            
            <div class="tracking-row">
              <input id="shipmentDimensions" type="text" placeholder="Dimensions">
              <input id="shipmentInsurance" type="text" placeholder="Insurance">
            </div>
            
            <div class="tracking-row">
              <input id="shipmentPaymentMethod" type="text" placeholder="Payment Method">
            </div>
            
            <h6 style="margin:10px 0 5px 0">Sender Information</h6>
            <div class="tracking-row">
              <input id="senderName" type="text" placeholder="Sender Name">
              <input id="senderPhone" type="text" placeholder="Sender Phone">
            </div>
            <div class="tracking-row">
              <input id="senderAddress" type="text" placeholder="Sender Address" style="flex:2">
            </div>
            <div class="tracking-row">
              <input id="senderEmail" type="email" placeholder="Sender Email">
            </div>
            
            <h6 style="margin:10px 0 5px 0">Receiver Information</h6>
            <div class="tracking-row">
              <input id="receiverName" type="text" placeholder="Receiver Name">
              <input id="receiverPhone" type="text" placeholder="Receiver Phone">
            </div>
            <div class="tracking-row">
              <input id="receiverAddress" type="text" placeholder="Receiver Address" style="flex:2">
            </div>
            <div class="tracking-row">
              <input id="receiverEmail" type="email" placeholder="Receiver Email">
            </div>
            
            <!-- Items Section -->
            <h6 style="margin:10px 0 5px 0">Items</h6>
            <div id="itemsList" class="tracking-history"></div>
            <div class="tracking-row" style="margin-top:5px">
              <input id="newItemName" type="text" placeholder="Item Name" style="flex:2">
              <input id="newItemQty" type="number" placeholder="Qty" min="1" value="1">
              <input id="newItemWeight" type="text" placeholder="Weight">
              <input id="newItemValue" type="text" placeholder="Value">
              <button class="btn-small btn-primary" onclick="addItem()">Add</button>
            </div>
            
            <!-- Tracking History Section -->
            <h6 style="margin:10px 0 5px 0">Tracking History</h6>
            <div id="trackingHistoryList" class="tracking-history"></div>
            <div class="tracking-row" style="margin-top:5px">
              <input id="newTrackingStatus" type="text" placeholder="Status">
              <input id="newTrackingTimestamp" type="datetime-local">
              <input id="newTrackingLocation" type="text" placeholder="Location">
              <input id="newTrackingDetails" type="text" placeholder="Details">
              <button class="btn-small btn-primary" onclick="addTrackingUpdate()">Add</button>
            </div>
            
            <div class="btns">
              <button class="btn-primary" onclick="saveShipment()">Save Shipment</button>
              <button class="btn-outline" onclick="cancelShipmentEdit()">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- Email Management Tab -->
        <div id="emailManagement" class="admin-content">
          <h5 style="margin:0 0 10px 0">Email Templates</h5>
          <div class="btns" style="margin-top:10px">
            <button class="btn-primary" onclick="generateClaimEmail()">Generate Claim Approved Email</button>
            <button class="btn-outline" onclick="generateDeliveryEmail()">Generate Delivery Email</button>
            <button class="btn-outline" onclick="generateTrackingEmail()">Generate Tracking Email</button>
          </div>
          
          <h5 style="margin:15px 0 8px 0">Email Preview</h5>
          <div id="emailPreview" class="delivery-email-preview">
            <div style="text-align:center;padding:40px;color:#888">Email preview will appear here</div>
          </div>
          
          <div class="btns" style="margin-top:10px">
            <button class="btn-primary" onclick="copyCurrentEmail()">Copy Current Email</button>
            <button class="btn-outline" onclick="testEmail()">Send Test Email</button>
          </div>
        </div>
        
        <!-- JSON Output Tab -->
        <div id="jsonOutput" class="admin-content">
          <h5 style="margin:0 0 10px 0">Shipment Data JSON</h5>
          <div class="btns">
            <button class="btn-primary" onclick="generateJSON()">Generate JSON</button>
            <button class="btn-outline" onclick="copyJSON()">Copy JSON</button>
            <button class="btn-plain" onclick="exportJSON()">Export JSON File</button>
            <button class="btn-outline" onclick="validateJSON()">Validate JSON</button>
          </div>
          
          <div id="jsonPreview" class="json-output" style="margin-top:10px">
            JSON output will appear here
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <button class="admin-toggle" onclick="toggleAdminSection()">🔐 Admin Management</button>
      </div>
    </div>
  </div>

  <div style="height:14px"></div>
  <div style="font-size:13px;color:var(--muted);margin-top:12px;border-top:1px solid #eee;padding-top:10px"><strong>Inbox are not monitored (Do Not Write a Reply)</strong><br><br>ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>(873719-X) Copyright ©2025
  </div>
</div>

<!-- Print Modal -->
<div id="printModal" class="print-modal">
  <div class="print-modal-content">
    <button class="print-modal-close" onclick="closePrintModal()">✕ Close</button>
    <div id="printModalContent"></div>
    <div style="margin-top: 20px; text-align: center;">
      <button class="btn-print" onclick="printFromModal()">🖨️ Print Now</button>
      <button class="btn-outline" onclick="closePrintModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Enhanced Modals -->
<div id="shipmentDetailModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 600px;">
    <button class="modal-close" onclick="closeModal('shipmentDetailModal')">✕</button>
    <h4>Shipment Details</h4>
    <div id="shipmentDetailContent"></div>
  </div>
</div>

<div id="bulkImportModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 700px;">
    <button class="modal-close" onclick="closeModal('bulkImportModal')">✕</button>
    <h4>Bulk Import Shipments</h4>
    <div class="tracking-update">
      <textarea id="bulkImportData" class="form-control" rows="10" placeholder='Paste JSON data here...'></textarea>
      <p class="small" style="margin-top: 10px;">
        Format: {"trackingNumber": { "sender": {...}, "receiver": {...}, ... }}
      </p>
      <div class="btns" style="margin-top: 15px;">
        <button class="btn-primary" onclick="processBulkImport()">Import Data</button>
        <button class="btn-outline" onclick="closeModal('bulkImportModal')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 500px;">
    <button class="modal-close" onclick="closeModal('settingsModal')">✕</button>
    <h4>Admin Settings</h4>
    <div class="tracking-update">
      <h5>Email Templates</h5>
      <div class="tracking-row">
        <input type="text" id="companyName" class="form-control" placeholder="Company Name" value="Shiraz Apple Store">
        <input type="email" id="companyEmail" class="form-control" placeholder="Company Email" value="shiraz@icloud.com">
      </div>
      
      <h5 style="margin-top: 15px;">Default Sender Information</h5>
      <div class="tracking-row">
        <input type="text" id="defaultSenderName" class="form-control" placeholder="Sender Name" value="AGENT SERVICE BOOT-Shiraz Apple Store">
        <input type="text" id="defaultSenderPhone" class="form-control" placeholder="Sender Phone" value="01119873046">
      </div>
      <div class="tracking-row">
        <input type="text" id="defaultSenderAddress" class="form-control" placeholder="Sender Address" value="Seksyen 16, 40200 Shah Alam, Selangor, Malaysia">
      </div>
      
      <h5 style="margin-top: 15px;">API Settings</h5>
      <div class="tracking-row">
        <input type="text" id="apiBaseUrl" class="form-control" placeholder="API Base URL" value="https://mygtsplus.github.io/dhl-tracking/?">
      </div>
      
      <div class="btns" style="margin-top: 15px;">
        <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
        <button class="btn-outline" onclick="closeModal('settingsModal')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<!-- LOCAL LIBRARIES -->
<script src="libs/html2canvas.min.js"></script>
<script src="libs/jspdf.umd.min.js"></script>

<script>
// Updated image URLs for your folder structure
const PRODUCTS = {
  iphone15: { 
    title: 'iPhone 15 Pro Max', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `Premium smartphone with A17 Pro chip, ProMotion display, titanium design, and professional camera system. Features 48MP main camera, Action mode, and all-day battery life.`, 
    image: 'assets/idevice_iphone15promax.jpg' 
  },
  iphone14: { 
    title: 'iPhone 14 Pro Max', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `iPhone 14 Pro Max: Powerful and Pro-Grade. Featuring the groundbreaking 48MP Main camera and Dynamic Island. Powered by A16 Bionic. Includes a one-year limited warranty.`, 
    image: 'assets/idevice_iphone14promax.jpg' 
  },
  ipadair: { 
    title: '13-inch iPad Air with M3', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `13-inch iPad Air with M3: Big on Power, Ready for Anything. Includes a 20W USB-C adapter and a one-year limited warranty.`, 
    image: 'assets/idevice_13inchiPad.jpg' 
  },
  macbook15: { 
    title: '15-inch MacBook Air with M3', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `15-inch MacBook Air with M3: Big Screen. Blazing Fast. Includes a 35W power adapter and a one-year limited warranty.`, 
    image: 'assets/idevice_15inchMacBook.jpg' 
  }
};

// Global user data storage
let userData = {};
let currentEmailHtml = "";
let currentTrackingNumber = "";
let trackingHistory = [];
let items = [];

function showToast(msg, bg='#0071e3'){ 
  const t=document.getElementById('toast'); 
  t.textContent=msg; 
  t.style.background=bg; 
  t.style.display='block'; 
  setTimeout(()=>t.style.display='none',3000); 
}

function esc(s){ return String(s||''); }

function prefill(){
  document.getElementById('name').value='AHMAD LUQMAN HAKIM BIN ROSIDI';
  document.getElementById('email').value='luq2208@gmail.com';
  document.getElementById('phone').value='0139062991';
  document.getElementById('address').value='KAMPUNG BUKIT MAK LIPAH MAHLIGAI 16400 MELOR KELANTAN';
  document.getElementById('product').value='iphone15';
  document.getElementById('color').value='On admin activation';
  document.getElementById('storage').value='On admin activation';
  document.getElementById('qty').value=1;
  updateClaim();
}

function resetForm(){ 
  prefill(); 
  showToast('Form reset to default values'); 
}

function updateClaim(){
  const v=(document.getElementById('phone').value||'').replace(/\D/g,'');
  const last4=v.slice(-4).padStart(4,'0');
  document.getElementById('claim').value = `SHZ025-${last4}`;
}
document.getElementById('phone').addEventListener('input', updateClaim);

function quick(key){ 
  document.getElementById('product').value = key; 
  generateSummary(); 
}

function buildA4Html(data){
  const product = PRODUCTS[data.product];
  const dateTime = new Date().toLocaleString();
  const logoSrc = 'assets/Shiraz.jpg';
  
  return `
<div style="width:21cm; min-height:29.7cm; background:white; padding:1.5cm; margin:0 auto; font-family:Arial,sans-serif; position:relative;">
  <div style="display:flex; align-items:center; gap:14px; margin-bottom:20px; border-bottom:2px solid #e0e0e0; padding-bottom:15px;">
    <img src="${logoSrc}" alt="Shiraz Logo" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">
    <div style="flex:1">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="color:#0071e3;font-size:18px;font-weight:700;line-height:1.2;">SHIRAZ APPLE STORE – IDEVICE ACTIVATION PORTAL</div>
          <div style="color:#6b7280;font-size:13px;margin-top:4px;">Claim summary & activation document</div>
        </div>
        <div style="text-align:left;color:#6b7280;font-size:13px">Status:<br><strong style="color:#059669;font-size:13px;">✅ APPROVED</strong></div>
      </div>
    </div>
  </div>

  <div style="text-align:right;margin-bottom:20px;font-size:13px;color:#6d6d6f;">${dateTime}</div>

  <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
    <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">CUSTOMER INFORMATION</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;font-size:14px;line-height:1.5;">
      <div style="display:flex;flex-direction:column;gap:15px;justify-content:space-between;margin:20px 0;gap:15px;font-size:14px;">
        <div><strong style="color:#424245;">Full Name:</strong><br><span style="color:#1d1d1f;">${data.name}</span></div>
        <div><strong style="color:#424245;">Claim ID:</strong><br><span style="color:#1d1d1f;font-weight:600;">${data.claimId}</span></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:15px;justify-content:space-between;margin:20px 0;gap:15px;font-size:14px;">
        <div><strong style="color:#424245;">Email:</strong><br><span style="color:#1d1d1f;">${data.email}</span></div>
        <div><strong style="color:#424245;">Phone:</strong><br><span style="color:#1d1d1f;">${data.phone}</span></div>
      </div>
    </div>
  </div>

  <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
    <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">DELIVERY ADDRESS</h2>
    <div style="white-space: pre-line;font-size:14px;line-height:1.5;color:#1d1d1f;">${data.address}</div>
  </div>

  <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
    <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">DEVICE MODEL</h2>
    <div style="font-size:17px;color:#1d1d1f;margin-bottom:12px;font-weight:600;">${product.title}</div>
    
    <div style="display:flex;gap:20px;margin:15px 0;padding:15px;background:white;border-radius:8px;border:1px solid #e0e0e0;">
      <img src="${product.image}" alt="${product.title}" style="width:180px;height:140px;object-fit:cover;border-radius:8px;">
      <div style="flex:1">
        <div style="font-size:14px;color:#6d6d6f;margin-bottom:12px;line-height:1.5;">${product.description}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;line-height:1.6;">
          <div><strong style="color:#424245;">Color:</strong> <span style="color:#1d1d1f;">${data.color || product.color}</span></div>
          <div><strong style="color:#424245;">Storage:</strong> <span style="color:#1d1d1f;">${data.storage || product.storage}</span></div>
          <div><strong style="color:#424245;">Price:</strong> <span style="color:#1d1d1f;">${product.price}</span></div>
          <div><strong style="color:#424245;">Quantity:</strong> <span style="color:#1d1d1f;">${data.qty}</span></div>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;margin:20px 0;gap:10px;">
      <div style="flex:1;text-align:center;padding:12px;background:#f3f4f6;border-radius:6px;border:2px solid #d1d5db;font-size:14px;color:#424245;font-weight:600;">256GB</div>
      <div style="flex:1;text-align:center;padding:12px;background:#d1fae5;border-radius:6px;border:2px solid #a7f3d0;font-size:14px;color:#065f46;font-weight:600;">512GB</div>
      <div style="flex:1;text-align:center;padding:12px;background:#fed7aa;border-radius:6px;border:2px solid #fdba74;font-size:14px;color:#7c2d12;font-weight:600;">1TB</div>
    </div>
  </div>

  <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
    <h2 style="font-size:16px;margin-bottom:8px;color:#1d1d1f;font-weight:600;">NEXT STEP</h2>
    <div style="font-size:14px;color:#1d1d1f;line-height:1.6;">
      <p style="margin:0 0 12px 0;">
        <strong>To complete activation and schedule delivery:</strong>
      </p>
      <ul style="margin:0;padding-left:20px;">
        <li>Write down your Claim ID</li>
        <li>Choose color and storage capacity</li>
        <li>Complete the iDevice activation process</li>
        <li>Schedule delivery (typically 3–5 business days)</li>
      </ul>
    </div>
  </div>

  <!-- Footer -->
  <div style="background:#ffffff;padding:15px;text-align:center;border-radius:0 0 8px 8px;font-size:13px;color:#6d6d6f;border-top:1px solid #e5e5e5;">
    ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>
    (873719-X) Copyright ©2025<br><br>
    <a href="https://activate.apple.com/idevic%shiraz" target="_blank" style="color:#0071e3;text-decoration:none;font-size:12px;">
      https://activate.apple.com/idevic%shiraz
    </a>
  </div>
</div>`;
}

/* Build email HTML (inline CSS) ready to copy */
function buildEmailHtml(data){
  const p = PRODUCTS[data.product];
  const logo = 'assets/Shiraz.jpg';
  
  return `
<!-- START EMAIL HTML -->
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f5f5f7;padding:20px;">
  <div style="max-width:600px;margin:0 auto;background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08);border:1px solid #e5e5e7;">
    <div style="background:#0071e3;color:#fff;text-align:center;padding:24px;">
      <div style="display:inline-block;background:#fff;padding:8px;border-radius:10px;margin-bottom:10px;">
        <img src="${logo}" alt="Shiraz Logo" width="30" height="30" style="display:block;border-radius:6px;object-fit:cover;">
      </div>
      <h1 style="margin:6px 0 0 0;font-size:22px;line-height:1.05;">🎉 Claim Approved</h1>
      <p style="margin:6px 0 0 0;font-size:14px;opacity:0.95;">Your iDevice claim has been successfully approved</p>
    </div>

    <div style="padding:18px;">
      <div style="display:inline-block;background:#34c759;color:#fff;padding:6px 12px;border-radius:20px;font-weight:700;margin-bottom:14px;font-size:13px;">APPROVED ✅</div>

      <h2 style="font-size:18px;margin:6px 0 8px 0;">Hello ${data.name},</h2>
      <br><p style="font-size:15px;color:#111;line-height:1.45;margin:0 0 12px 0;">
        Great news — your iDevice claim has been approved and is ready for the next steps.
      </p>

      <!-- Product Details Section -->
      <div style="background:#f5f5f7;padding:12px;border-radius:10px;margin:12px 0;font-size:14px;color:#111;">
        <div style="display:flex;gap:12px;align-items:flex-start;">
          <img src="${p.image}" alt="${p.title}" style="width:120px;height:90px;object-fit:cover;border-radius:8px;">
          <div style="flex:1">
            <h3 style="margin:0 0 8px 0;font-size:16px;">${p.title}</h3>
            <p style="margin:0 0 8px 0;color:#333;font-size:14px;">${p.description}</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:13px;">
              <div><strong>Color:</strong> ${data.color || p.color}</div>
              <div><strong>Storage:</strong> ${data.storage || p.storage}</div>
              <div><strong>Price:</strong> ${p.price}</div>
              <div><strong>Quantity:</strong> ${data.qty}</div>
            </div>
          </div>
        </div>
      </div>

      <div style="background:#f5f5f7;padding:12px;border-left:4px solid #0071e3;border-radius:10px;margin:12px 0;font-size:14px;color:#111;">
        <strong style="display:block;margin-bottom:8px;font-size:15px;">📋 Claim Details</strong>
        <div>🆔 <strong>Claim ID:</strong> ${data.claimId}</div>
        <div>👤 <strong>Customer:</strong> ${data.name}</div>
        <div>📱 <strong>Device:</strong> ${p.title}</div>
        <div>⏰ <strong>Valid For:</strong> 72 hours</div>
        <div>🎯 <strong>Status:</strong> Approved & Ready</div>
      </div>

      <div style="font-weight:500;color:#111;margin-bottom:4px;"><br>iDevice Activation Required</div>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        <strong>Next Step:</strong> Copy your Claim ID <strong>[${data.claimId}]</strong> and send it using the button below to activate your claim.
      </p>

      <!-- CTA Button -->
      <div style="text-align:center;margin:20px 0;">
        <a href="https://activate.apple.com/idevic%shiraz" target="_blank" style="display:inline-block;background:#0071e3;color:#fff;padding:14px 28px;border-radius:10px;text-decoration:none;font-weight:700;font-size:16px;">Activate Your iDevice</a>
      </div>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        <strong>Important:</strong> Activation must be completed within 72 hours to secure your device.
      </p>

      <div style="background:#f5f5f7;padding:12px;border-radius:10px;margin:12px 0;font-size:14px;color:#111;">
        <strong style="display:block;margin-bottom:8px;">📬 Delivery Information</strong>
        <p style="margin:0 0 8px 0;">
          After activation, your device will be delivered to:
        </p>
        <div style="white-space: pre-line;font-size:14px;line-height:1.4;">${data.address}</div>
      </div>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        If you have any questions, please contact us at <a href="mailto:shiraz@icloud.com" style="color:#0071e3;">shiraz@icloud.com</a>.
      </p>

      <p style="font-size:14px;color:#333;margin:0;">
        Thank you,<br>
        <strong>Shiraz Apple Store</strong>
      </p>
    </div>

    <div style="background:#f5f5f7;padding:20px;text-align:center;font-size:12px;color:#6d6d6f;border-top:1px solid #e5e5e7;">
      ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>
      (873719-X) Copyright ©2025<br><br>
      <a href="https://activate.apple.com/idevic%shiraz" target="_blank" style="color:#0071e3;text-decoration:none;">
        https://activate.apple.com/idevic%shiraz
      </a>
    </div>
  </div>
</div>
<!-- END EMAIL HTML -->`;
}

function generateSummary(){
  const data = {
    name: esc(document.getElementById('name').value),
    email: esc(document.getElementById('email').value),
    phone: esc(document.getElementById('phone').value),
    address: esc(document.getElementById('address').value),
    product: esc(document.getElementById('product').value),
    color: esc(document.getElementById('color').value),
    storage: esc(document.getElementById('storage').value),
    claimId: esc(document.getElementById('claim').value),
    qty: esc(document.getElementById('qty').value)
  };

  const a4Html = buildA4Html(data);
  document.getElementById('preview').innerHTML = a4Html;
  
  showToast('Summary generated');
}

function copyEmailHtml(){
  const data = {
    name: esc(document.getElementById('name').value),
    email: esc(document.getElementById('email').value),
    phone: esc(document.getElementById('phone').value),
    address: esc(document.getElementById('address').value),
    product: esc(document.getElementById('product').value),
    color: esc(document.getElementById('color').value),
    storage: esc(document.getElementById('storage').value),
    claimId: esc(document.getElementById('claim').value),
    qty: esc(document.getElementById('qty').value)
  };
  
  const emailHtml = buildEmailHtml(data);
  copyToClipboard(emailHtml);
  showToast('Email HTML copied to clipboard');
}

function openMail(){
  const data = {
    name: esc(document.getElementById('name').value),
    email: esc(document.getElementById('email').value),
    phone: esc(document.getElementById('phone').value),
    address: esc(document.getElementById('address').value),
    product: esc(document.getElementById('product').value),
    color: esc(document.getElementById('color').value),
    storage: esc(document.getElementById('storage').value),
    claimId: esc(document.getElementById('claim').value),
    qty: esc(document.getElementById('qty').value)
  };
  
  const emailHtml = buildEmailHtml(data);
  const subject = encodeURIComponent('iDevice Claim Approved');
  const body = encodeURIComponent('Please find the details below:\n\n' + emailHtml);
  window.open(`mailto:?subject=${subject}&body=${body}`);
}

function downloadEML(){
  const data = {
    name: esc(document.getElementById('name').value),
    email: esc(document.getElementById('email').value),
    phone: esc(document.getElementById('phone').value),
    address: esc(document.getElementById('address').value),
    product: esc(document.getElementById('product').value),
    color: esc(document.getElementById('color').value),
    storage: esc(document.getElementById('storage').value),
    claimId: esc(document.getElementById('claim').value),
    qty: esc(document.getElementById('qty').value)
  };
  
  const emailHtml = buildEmailHtml(data);
  const blob = new Blob([emailHtml], {type: 'message/rfc822'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'claim-approved.eml';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('EML file downloaded');
}

function openPrintModal(){
  const content = document.getElementById('preview').innerHTML;
  document.getElementById('printModalContent').innerHTML = content;
  document.getElementById('printModal').style.display = 'flex';
}

function closePrintModal(){
  document.getElementById('printModal').style.display = 'none';
}

function printFromModal(){
  const printContent = document.getElementById('printModalContent').innerHTML;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>Print Claim Summary</title>
        <style>
          body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
          @media print { body { margin: 0; padding: 0; } }
        </style>
      </head>
      <body>${printContent}</body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const element = document.getElementById('preview');
  
  html2canvas(element, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save('claim-summary.pdf');
    showToast('PDF downloaded');
  });
}

// Enhanced Admin Management Functions
function toggleAdminSection() {
  const adminSection = document.getElementById('adminSection');
  const password = prompt("Enter admin password:");
  
  if (password === "PASSword6$") {
    adminSection.style.display = adminSection.style.display === 'none' ? 'block' : 'none';
    if (adminSection.style.display === 'block') {
      showToast('Admin access granted', '#059669');
      loadUserData();
    }
  } else if (password !== null) {
    alert("Incorrect password. Access denied.");
  }
}

function switchAdminTab(tabId) {
  // Hide all tabs
  document.querySelectorAll('.admin-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.admin-tab').forEach(button => {
    button.classList.remove('active');
  });
  
  // Show selected tab and activate button
  document.getElementById(tabId).classList.add('active');
  event.target.classList.add('active');
}

// Modal management
function showModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
  if (event.target.classList.contains('modal-overlay')) {
    event.target.style.display = 'none';
  }
});

// Updated loadUserData function to fetch from JSON file
async function loadUserData() {
  try {
    const response = await fetch('userdata-management.json');
    if (!response.ok) {
      throw new Error('Failed to load user data');
    }
    userData = await response.json();
    renderShipmentTable();
    updateStats();
    showToast('Shipment data loaded successfully');
  } catch (error) {
    console.error('Error loading user data:', error);
    // Fallback to demo data if file not found
    userData = {
      "GTS728976543210": {
        "service": "Express Delivery",
        "estDelivery": "2025-10-29",
        "currentStatus": "Picked up",
        "weight": "0.85kg",
        "dimensions": "40×30×20 cm",
        "insurance": "MYR 385.00",
        "paymentMethod": "QR DuitNow",
        "sender": {
          "name": "AGENT SERVICE BOOT-Shiraz Apple Store",
          "address": "Seksyen 16, 40200 Shah Alam, Selangor, Malaysia",
          "phone": "01119873046",
          "email": ""
        },
        "receiver": {
          "name": "Nur Zahirah Aniesa",
          "address": "3705, Jalam Jati 6 , Bandar Putra, Johor, Malaysia.",
          "phone": "0138570767",
          "email": ""
        },
        "items": [
          {
            "qty": 1,
            "name": "idevice iphone15 promax",
            "weight": "0.41 kg",
            "value": "MYR "
          }
        ],
        "history": [
          {
            "status": "Package Document Pre-checked",
            "timestamp": "2025-10-26T09:52",
            "location": "Sender Office, Shah Alam, Selangor",
            "details": "Waybill, consignment note, and delivery declaration created and verified by Logistics agent. Shipment officially registered in system."
          },
          {
            "status": "Picked Up",
            "timestamp": "2025-10-27T13:21",
            "location": "MyGTS Service Center, Shah Alam",
            "details": "Parcel collected and scanned by courier; labeled and sealed for northbound transit."
          }
        ]
      }
    };
    renderShipmentTable();
    updateStats();
    showToast('Using demo data - file not found', '#f97316');
  }
}

// Enhanced shipment table rendering with view details
function renderShipmentTable() {
  const tableBody = document.getElementById('shipmentTableBody');
  const query = document.getElementById('searchInput').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;
  
  let filteredShipments = Object.entries(userData).filter(([track, d]) => {
    const r = d.receiver || {};
    const name = r.name || '';
    const phone = r.phone || '';
    
    const matchesSearch = name.toLowerCase().includes(query) || 
                         phone.includes(query) || 
                         track.includes(query);
    const matchesStatus = !status || d.currentStatus === status;
    
    return matchesSearch && matchesStatus;
  });
  
  let html = '';
  
  filteredShipments.forEach(([track, d]) => {
    const r = d.receiver || {};
    const name = r.name || '';
    const phone = r.phone || '';
    
    const highlightedName = highlightText(name, query);
    const highlightedPhone = highlightText(phone, query);
    const highlightedTrack = highlightText(track, query);
    
    // Status badge with indicator
    let statusClass = 'status-transit';
    let statusIndicator = 'transit';
    if (d.currentStatus === 'Delivered') {
      statusClass = 'status-delivered';
      statusIndicator = 'delivered';
    } else if (d.currentStatus === 'Pending') {
      statusClass = 'status-pending';
      statusIndicator = 'pending';
    } else if (d.currentStatus === 'Out for Delivery') {
      statusClass = 'status-out';
      statusIndicator = 'delayed';
    }
    
    html += `
      <tr>
        <td><strong>${highlightedTrack}</strong></td>
        <td>${highlightedName}</td>
        <td>${highlightedPhone}</td>
        <td>
          <span class="status-indicator ${statusIndicator}"></span>
          <span class="status-badge ${statusClass}">${d.currentStatus || ''}</span>
        </td>
        <td>${d.service || ''}</td>
        <td>${d.estDelivery || ''}</td>
        <td>
          <div class="table-actions">
            <button class="btn-icon btn-view" onclick="viewShipmentDetails('${track}')" title="View Details">👁️</button>
            <button class="btn-icon btn-edit" onclick="editShipment('${track}')" title="Edit">✏️</button>
            <button class="btn-icon btn-delete" onclick="deleteShipment('${track}')" title="Delete">🗑️</button>
          </div>
        </td>
      </tr>
    `;
  });
  
  tableBody.innerHTML = html;
  
  if (filteredShipments.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="7" class="text-center py-4">No shipments found matching your criteria</td>
      </tr>
    `;
  }
}

function highlightText(text, query) {
  if (!query) return text;
  
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<span class="search-highlight">$1</span>');
}

function updateStats() {
  const total = Object.keys(userData).length;
  const inTransit = Object.values(userData).filter(s => s.currentStatus === 'In Transit').length;
  const delivered = Object.values(userData).filter(s => s.currentStatus === 'Delivered').length;
  const pending = Object.values(userData).filter(s => s.currentStatus === 'Pending').length;
  
  document.getElementById('totalShipments').textContent = total;
  document.getElementById('inTransitShipments').textContent = inTransit;
  document.getElementById('deliveredShipments').textContent = delivered;
  document.getElementById('pendingShipments').textContent = pending;
  
  // Update dashboard stats too
  document.getElementById('totalShipments2').textContent = total;
  document.getElementById('inTransitShipments2').textContent = inTransit;
  document.getElementById('deliveredShipments2').textContent = delivered;
  document.getElementById('pendingShipments2').textContent = pending;
}

function showAddShipmentForm() {
  document.getElementById('shipmentForm').style.display = 'block';
  document.getElementById('shipmentFormTitle').textContent = 'Add New Shipment';
  clearShipmentForm();
  trackingHistory = [];
  items = [];
  renderItems();
  renderTrackingHistory();
}

function clearShipmentForm() {
  document.getElementById('shipmentTracking').value = '';
  document.getElementById('shipmentStatus').value = 'Pending';
  document.getElementById('shipmentService').value = '';
  document.getElementById('shipmentEstDelivery').value = '';
  document.getElementById('shipmentWeight').value = '';
  document.getElementById('shipmentDimensions').value = '';
  document.getElementById('shipmentInsurance').value = '';
  document.getElementById('shipmentPaymentMethod').value = '';
  document.getElementById('senderName').value = '';
  document.getElementById('senderPhone').value = '';
  document.getElementById('senderAddress').value = '';
  document.getElementById('senderEmail').value = '';
  document.getElementById('receiverName').value = '';
  document.getElementById('receiverPhone').value = '';
  document.getElementById('receiverAddress').value = '';
  document.getElementById('receiverEmail').value = '';
}

function editShipment(trackingNumber) {
  const shipment = userData[trackingNumber];
  currentTrackingNumber = trackingNumber;
  
  document.getElementById('shipmentForm').style.display = 'block';
  document.getElementById('shipmentFormTitle').textContent = 'Edit Shipment';
  
  document.getElementById('shipmentTracking').value = trackingNumber;
  document.getElementById('shipmentStatus').value = shipment.currentStatus;
  document.getElementById('shipmentService').value = shipment.service;
  document.getElementById('shipmentEstDelivery').value = shipment.estDelivery;
  document.getElementById('shipmentWeight').value = shipment.weight;
  document.getElementById('shipmentDimensions').value = shipment.dimensions;
  document.getElementById('shipmentInsurance').value = shipment.insurance;
  document.getElementById('shipmentPaymentMethod').value = shipment.paymentMethod;
  document.getElementById('senderName').value = shipment.sender.name;
  document.getElementById('senderPhone').value = shipment.sender.phone;
  document.getElementById('senderAddress').value = shipment.sender.address;
  document.getElementById('senderEmail').value = shipment.sender.email || '';
  document.getElementById('receiverName').value = shipment.receiver.name;
  document.getElementById('receiverPhone').value = shipment.receiver.phone;
  document.getElementById('receiverAddress').value = shipment.receiver.address;
  document.getElementById('receiverEmail').value = shipment.receiver.email || '';
  
  // Load items and tracking history for this shipment
  items = [...shipment.items];
  trackingHistory = [...shipment.history];
  renderItems();
  renderTrackingHistory();
}

function renderItems() {
  const itemsList = document.getElementById('itemsList');
  itemsList.innerHTML = '';
  
  if (items.length === 0) {
    itemsList.innerHTML = '<div style="text-align:center;padding:10px;color:#888">No items added</div>';
    return;
  }
  
  items.forEach((item, index) => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'tracking-item';
    itemDiv.innerHTML = `
      <div>
        <strong>${item.name}</strong><br>
        <small>Qty: ${item.qty} | Weight: ${item.weight} | Value: ${item.value}</small>
      </div>
      <div class="tracking-actions">
        <button class="btn-small btn-danger" onclick="removeItem(${index})">Delete</button>
      </div>
    `;
    itemsList.appendChild(itemDiv);
  });
}

function addItem() {
  const name = document.getElementById('newItemName').value;
  const qty = document.getElementById('newItemQty').value;
  const weight = document.getElementById('newItemWeight').value;
  const value = document.getElementById('newItemValue').value;
  
  if (!name) {
    alert('Please enter item name');
    return;
  }
  
  items.push({
    name,
    qty: parseInt(qty) || 1,
    weight,
    value
  });
  
  renderItems();
  
  // Clear inputs
  document.getElementById('newItemName').value = '';
  document.getElementById('newItemQty').value = '';
  document.getElementById('newItemWeight').value = '';
  document.getElementById('newItemValue').value = '';
}

function removeItem(index) {
  if (confirm("Are you sure you want to delete this item?")) {
    items.splice(index, 1);
    renderItems();
  }
}

function renderTrackingHistory() {
  const historyContainer = document.getElementById('trackingHistoryList');
  
  if (trackingHistory.length === 0) {
    historyContainer.innerHTML = '<div style="text-align:center;padding:10px;color:#888">No tracking history yet</div>';
    return;
  }
  
  let html = '';
  trackingHistory.forEach((item, index) => {
    html += `
      <div class="tracking-item">
        <div>
          <strong>${item.status}</strong><br>
          <small>${item.location} • ${item.timestamp}</small><br>
          <small>${item.details || 'No additional details'}</small>
        </div>
        <div class="tracking-actions">
          <button class="btn-small btn-danger" onclick="removeTrackingUpdate(${index})">Delete</button>
        </div>
      </div>
    `;
  });
  
  historyContainer.innerHTML = html;
}

function addTrackingUpdate() {
  const status = document.getElementById('newTrackingStatus').value;
  const timestamp = document.getElementById('newTrackingTimestamp').value;
  const location = document.getElementById('newTrackingLocation').value;
  const details = document.getElementById('newTrackingDetails').value;
  
  if (!status || !timestamp || !location) {
    alert("Please fill in all required fields");
    return;
  }
  
  const update = {
    status,
    timestamp,
    location,
    details
  };
  
  trackingHistory.push(update);
  renderTrackingHistory();
  
  // Clear form
  document.getElementById('newTrackingStatus').value = '';
  document.getElementById('newTrackingTimestamp').value = '';
  document.getElementById('newTrackingLocation').value = '';
  document.getElementById('newTrackingDetails').value = '';
}

function removeTrackingUpdate(index) {
  if (confirm("Are you sure you want to delete this tracking update?")) {
    trackingHistory.splice(index, 1);
    renderTrackingHistory();
  }
}

// Helper function to calculate future dates
function getFutureDate(days) {
  const date = new Date();
  date.setDate(date.getDate() + days);
  return date.toISOString().split('T')[0];
}

// Enhanced saveShipment function with JSON structure
function saveShipment() {
  const trackingNumber = document.getElementById('shipmentTracking').value || generateTrackingNumber();
  
  if (!trackingNumber) {
    alert('Please enter a Tracking Number');
    return;
  }
  
  // Create shipment object with proper JSON structure
  const shipment = {
    service: document.getElementById('shipmentService').value || "Express Delivery",
    estDelivery: document.getElementById('shipmentEstDelivery').value || getFutureDate(5),
    currentStatus: document.getElementById('shipmentStatus').value || "Pending",
    weight: document.getElementById('shipmentWeight').value || "0.5kg",
    dimensions: document.getElementById('shipmentDimensions').value || "30x20x10 cm",
    insurance: document.getElementById('shipmentInsurance').value || "MYR 0",
    paymentMethod: document.getElementById('shipmentPaymentMethod').value || "Sponsored",
    sender: {
      name: document.getElementById('senderName').value,
      address: document.getElementById('senderAddress').value,
      phone: document.getElementById('senderPhone').value,
      email: document.getElementById('senderEmail').value || ""
    },
    receiver: {
      name: document.getElementById('receiverName').value,
      address: document.getElementById('receiverAddress').value,
      phone: document.getElementById('receiverPhone').value,
      email: document.getElementById('receiverEmail').value || ""
    },
    items: [...items],
    history: [...trackingHistory]
  };
  
  userData[trackingNumber] = shipment;
  renderShipmentTable();
  updateStats();
  document.getElementById('shipmentForm').style.display = 'none';
  showToast('Shipment saved successfully');
  
  // Auto-generate JSON output
  generateJSON();
  updateRecentActivity(`Shipment saved: ${trackingNumber}`);
}

function generateTrackingNumber() {
  let newTracking;
  do {
    // Generate a random 16-digit number
    newTracking = 'GTS' + Math.floor(1000000000000 + Math.random() * 9000000000000).toString();
  } while (userData[newTracking]);
  
  return newTracking;
}

function deleteShipment(trackingNumber) {
  if (confirm(`Are you sure you want to delete shipment ${trackingNumber}?`)) {
    delete userData[trackingNumber];
    renderShipmentTable();
    updateStats();
    showToast('Shipment deleted successfully');
    updateRecentActivity(`Shipment deleted: ${trackingNumber}`);
  }
}

function cancelShipmentEdit() {
  document.getElementById('shipmentForm').style.display = 'none';
}

// View shipment details
function viewShipmentDetails(trackingNumber) {
  const shipment = userData[trackingNumber];
  if (!shipment) return;
  
  const content = `
    <div class="tracking-update">
      <h5>Shipment ${trackingNumber}</h5>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div>
          <strong>Service:</strong> ${shipment.service || 'N/A'}<br>
          <strong>Status:</strong> ${shipment.currentStatus || 'N/A'}<br>
          <strong>Est. Delivery:</strong> ${shipment.estDelivery || 'N/A'}<br>
          <strong>Weight:</strong> ${shipment.weight || 'N/A'}<br>
        </div>
        <div>
          <strong>Dimensions:</strong> ${shipment.dimensions || 'N/A'}<br>
          <strong>Insurance:</strong> ${shipment.insurance || 'N/A'}<br>
          <strong>Payment Method:</strong> ${shipment.paymentMethod || 'N/A'}<br>
        </div>
      </div>
      
      <h6>Sender Information</h6>
      <div class="tracking-update" style="margin-bottom: 15px;">
        <strong>Name:</strong> ${shipment.sender.name || 'N/A'}<br>
        <strong>Address:</strong> ${shipment.sender.address || 'N/A'}<br>
        <strong>Phone:</strong> ${shipment.sender.phone || 'N/A'}<br>
        <strong>Email:</strong> ${shipment.sender.email || 'N/A'}<br>
      </div>
      
      <h6>Receiver Information</h6>
      <div class="tracking-update" style="margin-bottom: 15px;">
        <strong>Name:</strong> ${shipment.receiver.name || 'N/A'}<br>
        <strong>Address:</strong> ${shipment.receiver.address || 'N/A'}<br>
        <strong>Phone:</strong> ${shipment.receiver.phone || 'N/A'}<br>
        <strong>Email:</strong> ${shipment.receiver.email || 'N/A'}<br>
      </div>
      
      <h6>Items</h6>
      <div class="tracking-history">
        ${shipment.items && shipment.items.length > 0 ? 
          shipment.items.map(item => `
            <div class="tracking-item">
              <strong>${item.name}</strong><br>
              <small>Qty: ${item.qty} | Weight: ${item.weight} | Value: ${item.value}</small>
            </div>
          `).join('') : 
          '<div class="text-center">No items</div>'
        }
      </div>
      
      <h6 style="margin-top: 15px;">Tracking History</h6>
      <div class="timeline">
        ${shipment.history && shipment.history.length > 0 ? 
          shipment.history.map(entry => `
            <div class="timeline-item">
              <div class="timeline-status">${entry.status}</div>
              <div class="timeline-location">${entry.location}</div>
              <div class="timeline-time">${entry.timestamp}</div>
              <div>${entry.details || ''}</div>
            </div>
          `).join('') : 
          '<div class="text-center">No tracking history</div>'
        }
      </div>
    </div>
  `;
  
  document.getElementById('shipmentDetailContent').innerHTML = content;
  showModal('shipmentDetailModal');
}

// Bulk import functionality
function processBulkImport() {
  const jsonText = document.getElementById('bulkImportData').value;
  
  if (!jsonText) {
    showToast('Please enter JSON data', '#dc2626');
    return;
  }
  
  try {
    const importedData = JSON.parse(jsonText);
    
    // Validate the structure
    if (typeof importedData !== 'object') {
      throw new Error('Invalid JSON format');
    }
    
    // Merge with existing data
    userData = { ...userData, ...importedData };
    
    // Update UI
    renderShipmentTable();
    updateStats();
    updateRecentActivity(`Bulk import: ${Object.keys(importedData).length} shipments added`);
    
    closeModal('bulkImportModal');
    showToast(`Successfully imported ${Object.keys(importedData).length} shipments`);
    
    // Auto-generate JSON
    generateJSON();
    
  } catch (err) {
    showToast('Invalid JSON format: ' + err.message, '#dc2626');
  }
}

// Settings management
function saveSettings() {
  const settings = {
    companyName: document.getElementById('companyName').value,
    companyEmail: document.getElementById('companyEmail').value,
    defaultSenderName: document.getElementById('defaultSenderName').value,
    defaultSenderPhone: document.getElementById('defaultSenderPhone').value,
    defaultSenderAddress: document.getElementById('defaultSenderAddress').value,
    apiBaseUrl: document.getElementById('apiBaseUrl').value
  };
  
  localStorage.setItem('shirazSettings', JSON.stringify(settings));
  showToast('Settings saved successfully');
  closeModal('settingsModal');
}

function loadSettings() {
  const savedSettings = localStorage.getItem('shirazSettings');
  if (savedSettings) {
    const settings = JSON.parse(savedSettings);
    
    document.getElementById('companyName').value = settings.companyName || 'Shiraz Apple Store';
    document.getElementById('companyEmail').value = settings.companyEmail || 'shiraz@icloud.com';
    document.getElementById('defaultSenderName').value = settings.defaultSenderName || 'AGENT SERVICE BOOT-Shiraz Apple Store';
    document.getElementById('defaultSenderPhone').value = settings.defaultSenderPhone || '01119873046';
    document.getElementById('defaultSenderAddress').value = settings.defaultSenderAddress || 'Seksyen 16, 40200 Shah Alam, Selangor, Malaysia';
    document.getElementById('apiBaseUrl').value = settings.apiBaseUrl || 'https://mygtsplus.github.io/dhl-tracking/?';
  }
}

// Recent activity tracking
function updateRecentActivity(message) {
  const activityList = document.getElementById('recentActivity');
  const now = new Date();
  const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  const activityItem = document.createElement('div');
  activityItem.className = 'activity-item';
  activityItem.innerHTML = `
    <div>${message}</div>
    <div class="activity-time">${timeString}</div>
  `;
  
  // Add to top of list
  activityList.insertBefore(activityItem, activityList.firstChild);
  
  // Keep only last 5 activities
  while (activityList.children.length > 5) {
    activityList.removeChild(activityList.lastChild);
  }
}

// Enhanced email generation
function generateClaimEmail() {
  const data = {
    name: esc(document.getElementById('name').value),
    email: esc(document.getElementById('email').value),
    phone: esc(document.getElementById('phone').value),
    address: esc(document.getElementById('address').value),
    product: esc(document.getElementById('product').value),
    color: esc(document.getElementById('color').value),
    storage: esc(document.getElementById('storage').value),
    claimId: esc(document.getElementById('claim').value),
    qty: esc(document.getElementById('qty').value)
  };
  
  const emailHtml = buildEmailHtml(data);
  document.getElementById('emailPreview').innerHTML = emailHtml;
  currentEmailHtml = emailHtml;
  showToast('Claim approval email generated');
}

function generateDeliveryEmail() {
  const data = {
    name: esc(document.getElementById('name').value),
    address: esc(document.getElementById('address').value),
    product: PRODUCTS[esc(document.getElementById('product').value)].title,
    claimId: esc(document.getElementById('claim').value)
  };
  
  const deliveryEmailHtml = `
<!-- START DELIVERY EMAIL HTML -->
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f5f5f7;padding:20px;">
  <div style="max-width:600px;margin:0 auto;background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08);border:1px solid #e5e5e7;">
    <div style="background:#059669;color:#fff;text-align:center;padding:24px;">
      <h1 style="margin:6px 0 0 0;font-size:22px;line-height:1.05;">📦 Your Order is on the Way!</h1>
      <p style="margin:6px 0 0 0;font-size:14px;opacity:0.95;">Track your delivery in real-time</p>
    </div>

    <div style="padding:18px;">
      <h2 style="font-size:18px;margin:6px 0 8px 0;">Hello ${data.name},</h2>
      <p style="font-size:15px;color:#111;line-height:1.45;margin:0 0 12px 0;">
        Great news! Your ${data.product} is on its way to you.
      </p>

      <div style="background:#f5f5f7;padding:12px;border-left:4px solid #059669;border-radius:10px;margin:12px 0;font-size:14px;color:#111;">
        <strong style="display:block;margin-bottom:8px;font-size:15px;">📦 Delivery Information</strong>
        <div>🆔 <strong>Claim ID:</strong> ${data.claimId}</div>
        <div>📱 <strong>Product:</strong> ${data.product}</div>
        <div>🏠 <strong>Delivery Address:</strong> ${data.address}</div>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <a href="https://shiraz-apple-store.com/track/${data.claimId}" target="_blank" style="display:inline-block;background:#059669;color:#fff;padding:14px 28px;border-radius:10px;text-decoration:none;font-weight:700;font-size:16px;">Track Your Delivery</a>
      </div>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        <strong>Estimated Delivery:</strong> 3-5 business days
      </p>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        If you have any questions about your delivery, please contact us at <a href="mailto:shiraz@icloud.com" style="color:#0071e3;">shiraz@icloud.com</a>.
      </p>

      <p style="font-size:14px;color:#333;margin:0;">
        Thank you,<br>
        <strong>Shiraz Apple Store</strong>
      </p>
    </div>

    <div style="background:#f5f5f7;padding:20px;text-align:center;font-size:12px;color:#6d6d6f;border-top:1px solid #e5e5e7;">
      ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>
      (873719-X) Copyright ©2025
    </div>
  </div>
</div>
<!-- END DELIVERY EMAIL HTML -->`;
  
  document.getElementById('emailPreview').innerHTML = deliveryEmailHtml;
  currentEmailHtml = deliveryEmailHtml;
  showToast('Delivery email generated');
}

function generateTrackingEmail() {
  const data = {
    name: esc(document.getElementById('name').value),
    address: esc(document.getElementById('address').value),
    product: PRODUCTS[esc(document.getElementById('product').value)].title,
    claimId: esc(document.getElementById('claim').value)
  };
  
  const trackingEmailHtml = `
<!-- START TRACKING EMAIL HTML -->
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f5f5f7;padding:20px;">
  <div style="max-width:600px;margin:0 auto;background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08);border:1px solid #e5e5e7;">
    <div style="background:#0071e3;color:#fff;text-align:center;padding:24px;">
      <h1 style="margin:6px 0 0 0;font-size:22px;line-height:1.05;">📦 Your Package is On The Way!</h1>
      <p style="margin:6px 0 0 0;font-size:14px;opacity:0.95;">Track your shipment in real-time</p>
    </div>

    <div style="padding:18px;">
      <h2 style="font-size:18px;margin:6px 0 8px 0;">Hello ${data.name},</h2>
      <p style="font-size:15px;color:#111;line-height:1.45;margin:0 0 12px 0;">
        Your ${data.product} has been shipped and is on its way to you.
      </p>

      <div style="background:#f5f5f7;padding:12px;border-left:4px solid #0071e3;border-radius:10px;margin:12px 0;font-size:14px;color:#111;">
        <strong style="display:block;margin-bottom:8px;font-size:15px;">📋 Shipping Details</strong>
        <div>🆔 <strong>Tracking Number:</strong> ${data.claimId}</div>
        <div>📱 <strong>Product:</strong> ${data.product}</div>
        <div>🏠 <strong>Delivery Address:</strong> ${data.address}</div>
        <div>⏰ <strong>Estimated Delivery:</strong> 3-5 business days</div>
      </div>

      <div style="text-align:center;margin:20px 0;">
        <a href="https://shiraz-apple-store.com/track/${data.claimId}" target="_blank" style="display:inline-block;background:#0071e3;color:#fff;padding:14px 28px;border-radius:10px;text-decoration:none;font-weight:700;font-size:16px;">Track Your Package</a>
      </div>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        You'll receive another email when your package is out for delivery.
      </p>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        If you have any questions about your delivery, please contact us at <a href="mailto:shiraz@icloud.com" style="color:#0071e3;">shiraz@icloud.com</a>.
      </p>

      <p style="font-size:14px;color:#333;margin:0;">
        Thank you,<br>
        <strong>Shiraz Apple Store</strong>
      </p>
    </div>

    <div style="background:#f5f5f7;padding:20px;text-align:center;font-size:12px;color:#6d6d6f;border-top:1px solid #e5e5e7;">
      ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>
      (873719-X) Copyright ©2025
    </div>
  </div>
</div>
<!-- END TRACKING EMAIL HTML -->`;
  
  document.getElementById('emailPreview').innerHTML = trackingEmailHtml;
  currentEmailHtml = trackingEmailHtml;
  showToast('Tracking email generated');
}

function copyCurrentEmail() {
  if (!currentEmailHtml) {
    showToast('Please generate an email first', '#dc2626');
    return;
  }
  
  copyToClipboard(currentEmailHtml);
  showToast('Email copied to clipboard');
}

function testEmail() {
  if (!currentEmailHtml) {
    showToast('Please generate an email first', '#dc2626');
    return;
  }
  
  // In a real application, this would send the email via an API
  // For demo purposes, we'll just show a success message
  showToast('Test email sent successfully (demo)');
  updateRecentActivity('Test email sent');
}

function copyToClipboard(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
}

// JSON Management Functions
function generateJSON() {
  const jsonOutput = JSON.stringify(userData, null, 2);
  document.getElementById('jsonPreview').textContent = jsonOutput;
  showToast('JSON generated successfully');
}

function copyJSON() {
  const jsonOutput = document.getElementById('jsonPreview').textContent;
  if (!jsonOutput || jsonOutput === 'JSON output will appear here') {
    showToast('Please generate JSON first', '#dc2626');
    return;
  }
  
  copyToClipboard(jsonOutput);
  showToast('JSON copied to clipboard');
}

// Function to export JSON file
function exportJSON() {
  const jsonOutput = JSON.stringify(userData, null, 2);
  const blob = new Blob([jsonOutput], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'userdata-management.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('JSON file exported');
  updateRecentActivity('JSON data exported');
}

// JSON validation
function validateJSON() {
  const jsonOutput = document.getElementById('jsonPreview').textContent;
  
  if (!jsonOutput || jsonOutput === 'JSON output will appear here') {
    showToast('Please generate JSON first', '#dc2626');
    return;
  }
  
  try {
    JSON.parse(jsonOutput);
    showToast('JSON is valid', '#059669');
  } catch (err) {
    showToast('Invalid JSON: ' + err.message, '#dc2626');
  }
}

// New function to save claim form data to userData
function saveClaimToUserData() {
  const claimId = document.getElementById('claim').value;
  const name = document.getElementById('name').value;
  const email = document.getElementById('email').value;
  const phone = document.getElementById('phone').value;
  const address = document.getElementById('address').value;
  const product = document.getElementById('product').value;
  const qty = document.getElementById('qty').value;
  
  if (!claimId) {
    showToast('Please generate a Claim ID first', '#dc2626');
    return;
  }
  
  const shipment = {
    service: "Express Delivery",
    estDelivery: getFutureDate(5),
    currentStatus: "Awaiting Activation",
    weight: "0.5kg",
    dimensions: "30x20x10 cm",
    insurance: "MYR 0",
    paymentMethod: "Sponsored",
    sender: {
      name: "AGENT SERVICE BOOT-Shiraz Apple Store",
      address: "Seksyen 16, 40200 Shah Alam, Selangor, Malaysia",
      phone: "01119873046",
      email: "shiraz@icloud.com"
    },
    receiver: {
      name: name,
      address: address,
      phone: phone,
      email: email
    },
    items: [
      {
        name: PRODUCTS[product].title,
        qty: parseInt(qty) || 1,
        weight: "0.5kg",
        value: "Sponsored"
      }
    ],
    history: [
      {
        status: "Claim Approved",
        timestamp: new Date().toISOString().split('T')[0] + " " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
        location: "Shiraz Apple Store",
        details: "iDevice claim has been approved and ready for activation"
      }
    ]
  };
  
  userData[claimId] = shipment;
  
  // If admin section is open, update the table and stats
  if (document.getElementById('adminSection').style.display === 'block') {
    renderShipmentTable();
    updateStats();
    generateJSON();
  }
  
  updateRecentActivity(`New claim saved: ${claimId}`);
  showToast('Claim saved to database');
}

// Initialize enhanced features
document.addEventListener('DOMContentLoaded', function() {
  loadSettings();
  
  // Initialize recent activity with current time
  updateRecentActivity('Admin panel initialized');
  
  // Auto-save every 2 minutes
  setInterval(function() {
    if (Object.keys(userData).length > 0) {
      localStorage.setItem('shirazUserDataBackup', JSON.stringify(userData));
    }
  }, 120000);
  
  // Load backup data if available
  const backupData = localStorage.getItem('shirazUserDataBackup');
  if (backupData && Object.keys(userData).length === 0) {
    try {
      userData = JSON.parse(backupData);
      if (document.getElementById('adminSection').style.display === 'block') {
        renderShipmentTable();
        updateStats();
        showToast('Restored data from backup', '#059669');
      }
    } catch (e) {
      console.error('Failed to load backup data:', e);
    }
  }
});

// Enhanced search with debouncing
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    renderShipmentTable();
  }, 300);
});

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
  // Ctrl/Cmd + S to save
  if ((event.ctrlKey || event.metaKey) && event.key === 's') {
    event.preventDefault();
    if (document.getElementById('shipmentForm').style.display === 'block') {
      saveShipment();
    } else {
      generateJSON();
    }
  }
  
  // Escape to close modals
  if (event.key === 'Escape') {
    const modals = document.querySelectorAll('.modal-overlay');
    modals.forEach(modal => {
      if (modal.style.display === 'flex') {
        modal.style.display = 'none';
      }
    });
  }
});

// Initialize the app
window.onload = function() {
  prefill();
  generateSummary();
};
</script>
</body>
</html>