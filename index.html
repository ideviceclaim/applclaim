<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Shiraz Store ‚Äî Checkout & PDF/Email Generator</title>
<style>
  :root{ --primary:#0071e3; --muted:#6b7280; --bg:#f7f7f8; --card:#fff; }
  *{box-sizing:border-box}
  body{margin:0;padding:18px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:#111}
  .container{max-width:1100px;margin:0 auto}
  .header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
  .logo{width:30px;height:30px;object-fit:cover;border-radius:4px}
  .title{margin:0;color:var(--primary);font-size:18px;font-weight:700}
  .subtitle{margin:0;color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:1fr 480px;gap:16px}
  @media(max-width:1000px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 26px rgba(0,0,0,0.06);border:1px solid rgba(0,0,0,0.04)}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type=text], input[type=email], input[type=number], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e8;background:#fff;font-size:15px}
  textarea{min-height:80px}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{padding:10px 12px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-outline{background:transparent;border:2px solid var(--primary);color:var(--primary)}
  .btn-plain{background:#374151;color:#fff}
  .btn-print{background:#059669;color:#fff}
  .btn-pdf{background:#dc2626;color:#fff}
  .preview{min-height:520px;border-radius:10px;border:2px solid #e6e6e8;padding:10px;background:#fff;overflow:auto;position:relative}
  .small{font-size:13px;color:var(--muted)}
  .watermark{position:absolute;opacity:0.07;pointer-events:none;transform:rotate(-20deg);right:-20px;bottom:80px;width:60%}
  .footer-note{font-size:13px;color:var(--muted);margin-top:10px}
  .toast{position:fixed;right:18px;top:18px;padding:10px 14px;border-radius:8px;color:white;display:none;z-index:9999}
  .email-preview{min-height:520px;border-radius:10px;border:2px solid #e6e6e8;padding:10px;background:#fff;overflow:auto}
  
  .print-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); display: none; justify-content: center; 
    align-items: center; z-index: 10000;
  }
  .print-modal-content {
    background: white; padding: 20px; border-radius: 12px;
    max-width: 90%; max-height: 90%; overflow: auto; position: relative;
  }
  .print-modal-close {
    position: absolute; top: 10px; right: 10px;
    background: #dc2626; color: white; border: none;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <img id="hdrLogo" class="logo" src="https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/Shiraz.jpg" alt="Shiraz Logo">
    <div style="flex:1">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="title">SHIRAZ APPLE ‚Äì IDEVICE CLAIM</div>
          <div class="subtitle">summary</div>
        </div>
        <div style="text-align:right;color:var(--muted);font-size:12px">Status: <strong style="color:#059669">‚úÖ APPROVED</strong></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3 style="margin:0 0 8px 0">Customer & Product</h3>
        <div style="margin-top:10px"><label for="name">Full Name</label><input id="name" type="text" value="AHMAD LUQMAN HAKIM BIN ROSIDI"></div>
        <div class="row" style="margin-top:10px">
          <div><label for="email">Email</label><input id="email" type="email" value="luq2208@gmail.com"></div>
          <div><label for="phone">Phone Number</label><input id="phone" type="text" value="0139062991" maxlength="18"></div>
        </div>
        <div style="margin-top:10px"><label for="address">Delivery Address</label><textarea id="address">KAMPUNG BUKIT MAK LIPAH MAHLIGAI 16400 MELOR KELANTAN</textarea></div>
        <div class="row" style="margin-top:10px">
          <div><label for="product">iDevice</label>
            <select id="product">
              <option value="iphone15">Apple iPhone 15 Pro Max</option>
              <option value="iphone14">Apple iPhone 14 Pro Max</option>
              <option value="ipadair">13-inch iPad Air with M3</option>
              <option value="macbook15">15-inch MacBook Air with M3</option>
            </select>
          </div>
          <div><label for="color">Color (Admin)</label><input id="color" type="text" value="On admin activation" disabled></div>
          <div><label for="storage">Storage (Admin)</label><input id="storage" type="text" value="On admin activation" disabled></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div><label>Claim ID (auto)</label><input id="claim" type="text" readonly></div>
          <div><label>Qty</label><input id="qty" type="number" min="1" value="1"></div>
        </div>

        <div style="margin-top:12px" class="btns">
          <button class="btn-primary" onclick="generateSummary()">Generate Summary</button>
          <button class="btn-pdf" onclick="downloadPDF()">üìÑ Download PDF</button>
          <button class="btn-print" onclick="openPrintModal()">üñ®Ô∏è Print Preview</button>
          <button class="btn-plain" onclick="resetForm()">Reset</button>
        </div>
        <p class="footer-note">Claim ID format: <code>SHZ025-{last4digitsOfPhone}</code></p>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px 0">Quick Select</h4>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('iphone15')"><strong>iPhone 15 Pro Max</strong><div class="small muted">Sponsored</div></div>
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('iphone14')"><strong>iPhone 14 Pro Max</strong><div class="small muted">Sponsored</div></div>
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('ipadair')"><strong>13-inch iPad Air</strong><div class="small muted">Sponsored</div></div>
          <div style="padding:8px;border-radius:8px;border:1px solid #eee;cursor:pointer" onclick="quick('macbook15')"><strong>15-inch MacBook Air</strong><div class="small muted">Sponsored</div></div>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h4 style="margin:0 0 8px 0">A4 PDF Preview (single page)</h4>
        <div id="preview" class="preview">
          <div style="text-align:center;padding:40px;color:#888">No summary yet ‚Äî click <strong>Generate Summary</strong></div>
          <img id="wm" class="watermark" src="" style="display:none" alt="watermark">
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="btn-primary" onclick="copyEmailHtml()">Copy Email HTML</button>
          <button class="btn-outline" onclick="openMail()">Open Mail</button>
          <button class="btn-outline" onclick="downloadEML()">Download .eml</button>
          <button class="btn-print" onclick="openPrintModal()">üñ®Ô∏è Print Preview</button>
        </div>
        <p class="footer-note">After copying: open Mail/Outlook and paste into body.</p>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px 0">Email Preview</h4>
        <div id="emailPreview" class="email-preview"><div style="text-align:center;padding:40px;color:#888">Email preview will appear here</div></div>
        <h4 style="margin:15px 0 8px 0">Email HTML (editable)</h4>
        <textarea id="emailHtml" style="width:100%;height:260px;border-radius:8px;border:1px solid #eee;font-family:monospace"></textarea>
        <div class="btns" style="margin-top:8px">
          <button class="btn-primary" onclick="copyEmailFromBox()">Copy from box</button>
          <button class="btn-outline" onclick="generateSummary()">Refresh HTML</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:14px"></div>
  <div style="font-size:13px;color:var(--muted);margin-top:12px;border-top:1px solid #eee;padding-top:10px"><strong>Inbox are not monitored (Do Not Write a Reply)</strong><br><br>ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>(873719-X) Copyright ¬©2025
  </div>
</div>

<!-- Print Modal -->
<div id="printModal" class="print-modal">
  <div class="print-modal-content">
    <button class="print-modal-close" onclick="closePrintModal()">‚úï Close</button>
    <div id="printModalContent"></div>
    <div style="margin-top: 20px; text-align: center;">
      <button class="btn-print" onclick="printFromModal()">üñ®Ô∏è Print Now</button>
      <button class="btn-outline" onclick="closePrintModal()">Cancel</button>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<!-- LOCAL LIBRARIES -->
<script src="libs/html2canvas.min.js"></script>
<script src="libs/jspdf.umd.min.js"></script>

<script>
// Updated image URLs to match your new structure
const PRODUCTS = {
  iphone15: { 
    title: 'iPhone 15 Pro Max', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `Premium smartphone with A17 Pro chip, ProMotion display, titanium design, and professional camera system. Features 48MP main camera, Action mode, and all-day battery life.`, 
    image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_iphone15promax.jpg' 
  },
  iphone14: { 
    title: 'iPhone 14 Pro Max', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `iPhone 14 Pro Max: Powerful and Pro-Grade. Featuring the groundbreaking 48MP Main camera and Dynamic Island. Powered by A16 Bionic. Includes a one-year limited warranty.`, 
    image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_iphone14promax.jpg' 
  },
  ipadair: { 
    title: '13-inch iPad Air with M3', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `13-inch iPad Air with M3: Big on Power, Ready for Anything. Includes a 20W USB-C adapter and a one-year limited warranty.`, 
    image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_13inchiPad.jpg' 
  },
  macbook15: { 
    title: '15-inch MacBook Air with M3', 
    price: '{Sponsored}', 
    color: 'On admin activation', 
    storage: 'On admin activation', 
    description: `15-inch MacBook Air with M3: Big Screen. Blazing Fast. Includes a 35W power adapter and a one-year limited warranty.`, 
    image: 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/idevice_15inchMacBook.jpg' 
  }
};

function showToast(msg, bg='#0071e3'){ 
  const t=document.getElementById('toast'); 
  t.textContent=msg; 
  t.style.background=bg; 
  t.style.display='block'; 
  setTimeout(()=>t.style.display='none',3000); 
}

function esc(s){ return String(s||''); }

function prefill(){
  document.getElementById('name').value='AHMAD LUQMAN HAKIM BIN ROSIDI';
  document.getElementById('email').value='luq2208@gmail.com';
  document.getElementById('phone').value='0139062991';
  document.getElementById('address').value='KAMPUNG BUKIT MAK LIPAH MAHLIGAI 16400 MELOR KELANTAN';
  document.getElementById('product').value='iphone15';
  document.getElementById('color').value='On admin activation';
  document.getElementById('storage').value='On admin activation';
  document.getElementById('qty').value=1;
  updateClaim();
}

function resetForm(){ 
  prefill(); 
  showToast('Form reset to default values'); 
}

function updateClaim(){
  const v=(document.getElementById('phone').value||'').replace(/\D/g,'');
  const last4=v.slice(-4).padStart(4,'0');
  document.getElementById('claim').value = `SHZ025-${last4}`;
}
document.getElementById('phone').addEventListener('input', updateClaim);

function quick(key){ 
  document.getElementById('product').value = key; 
  generateSummary(); 
}

function buildA4Html(data){
  const product = PRODUCTS[data.product];
  const dateTime = new Date().toLocaleString();
  const logoSrc = 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/Shiraz.jpg';
  
  return `
<div style="width:21cm; min-height:29.7cm; background:white; padding:1.5cm; margin:0 auto; font-family:Arial,sans-serif; position:relative;">
  <div style="display:flex; align-items:center; gap:14px; margin-bottom:20px; border-bottom:2px solid #e0e0e0; padding-bottom:15px;">
    <img src="${logoSrc}" alt="Shiraz Logo" style="width:40px;height:40px;object-fit:cover;border-radius:6px;">
    <div style="flex:1">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="color:#0071e3;font-size:20px;font-weight:700;line-height:1.2;">SHIRAZ APPLE STORE ‚Äì IDEVICE ACTIVATION PORTAL</div>
          <div style="color:#6b7280;font-size:13px;margin-top:4px;">Claim summary & activation document</div>
        </div>
        <div style="text-align:left;color:#6b7280;font-size:13px">Status:<br><strong style="color:#059669;font-size:14px;">‚úÖ APPROVED</strong></div>
      </div>
    </div>
  </div>

  <div style="text-align:right;margin-bottom:20px;font-size:13px;color:#6d6d6f;">${dateTime}</div>

                     <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                        <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">CUSTOMER INFORMATION</h2>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;font-size:14px;line-height:1.5;">
                            <div style="display:flex;flex-direction:column;gap:15px;justify-content:space-between;margin:20px 0;gap:15px;font-size:14px;">

                <div><strong style="color:#424245;">Full Name:</strong><br><span style="color:#1d1d1f;">${data.name}</span></div>
                                <div><strong style="color:#424245;">Claim ID:</strong><br><span style="color:#1d1d1f;font-weight:600;">${data.claimId}</span></div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:15px;justify-content:space-between;margin:20px 0;gap:15px;font-size:14px;">
                                <div><strong style="color:#424245;">Email:</strong><br><span style="color:#1d1d1f;">${data.email}</span></div>
                                <div><strong style="color:#424245;">Phone:</strong><br><span style="color:#1d1d1f;">${data.phone}</span></div>
      </div>
    </div>
  </div>

  <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
    <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">DELIVERY ADDRESS</h2>
    <div style="white-space: pre-line;font-size:14px;line-height:1.5;color:#1d1d1f;">${data.address}</div>
  </div>

  <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
    <h2 style="font-size:16px;margin-bottom:12px;color:#1d1d1f;font-weight:600;">DEVICE MODEL</h2>
    <div style="font-size:17px;color:#1d1d1f;margin-bottom:12px;font-weight:600;">${product.title}</div>
    
    <div style="display:flex;gap:20px;margin:15px 0;padding:15px;background:white;border-radius:8px;border:1px solid #e0e0e0;">
      <img src="${product.image}" alt="${product.title}" style="width:180px;height:140px;object-fit:cover;border-radius:8px;">
      <div style="flex:1">
        <div style="font-size:14px;color:#6d6d6f;margin-bottom:12px;line-height:1.5;">${product.description}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;line-height:1.6;">
          <div><strong style="color:#424245;">Color:</strong> <span style="color:#1d1d1f;">${data.color || product.color}</span></div>
          <div><strong style="color:#424245;">Storage:</strong> <span style="color:#1d1d1f;">${data.storage || product.storage}</span></div>
          <div><strong style="color:#424245;">Price:</strong> <span style="color:#1d1d1f;">${product.price}</span></div>
          <div><strong style="color:#424245;">Quantity:</strong> <span style="color:#1d1d1f;">${data.qty}</span></div>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;margin:20px 0;gap:10px;">
      <div style="flex:1;text-align:center;padding:12px;background:#f3f4f6;border-radius:6px;border:2px solid #d1d5db;font-size:14px;color:#424245;font-weight:600;">256GB</div>
      <div style="flex:1;text-align:center;padding:12px;background:#d1fae5;border-radius:6px;border:2px solid #a7f3d0;font-size:14px;color:#065f46;font-weight:600;">512GB</div>
      <div style="flex:1;text-align:center;padding:12px;background:#fed7aa;border-radius:6px;border:2px solid #fdba74;font-size:14px;color#7c2d12;font-weight:600;">1TB</div>
    </div>
  </div>

  <div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
    <h2 style="font-size:16px;margin-bottom:8px;color:#1d1d1f;font-weight:600;">NEXT STEP</h2>
    <div style="font-size:14px;color:#1d1d1f;line-height:1.6;">
      <p style="margin:0 0 12px 0;">
        <strong>To complete activation and schedule delivery:</strong>
      </p>
      <ul style="margin:0;padding-left:20px;">
        <li>Write down your Claim ID</li>
        <li>Choose color and storage capacity</li>
        <li>Complete the iDevice activation process</li>
        <li>Schedule delivery (typically 3‚Äì5 business days)</li>
      </ul>
    </div>
  </div>

  <!-- Footer -->
  <div style="background:#ffffff;padding:15px;text-align:center;border-radius:0 0 8px 8px;font-size:13px;color:#6d6d6f;border-top:1px solid #e5e5e5;">
    ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>
    (873719-X) Copyright ¬©2025<br><br>
    <a href="https://activate.apple.com/idevic%shiraz" target="_blank" style="color:#0071e3;text-decoration:none;font-size:12px;">
      https://activate.apple.com/idevic%shiraz
    </a>
  </div>
</div>`;
}

/* Build email HTML (inline CSS) ready to copy */
function buildEmailHtml(data){
  const p = PRODUCTS[data.product];
  const logo = 'https://raw.githubusercontent.com/ideviceclaim/applclaim/main/assets/Shiraz.jpg';
  
  return `
<!-- START EMAIL HTML -->
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f5f5f7;padding:20px;">
  <div style="max-width:600px;margin:0 auto;background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.08);border:1px solid #e5e5e7;">
    <div style="background:#0071e3;color:#fff;text-align:center;padding:24px;">
      <div style="display:inline-block;background:#fff;padding:8px;border-radius:10px;margin-bottom:10px;">
        <img src="${logo}" alt="Shiraz Logo" width="30" height="30" style="display:block;border-radius:6px;object-fit:cover;">
      </div>
      <h1 style="margin:6px 0 0 0;font-size:22px;line-height:1.05;">üéâ Claim Approved</h1>
      <p style="margin:6px 0 0 0;font-size:14px;opacity:0.95;">Your iDevice claim has been successfully approved</p>
    </div>

    <div style="padding:18px;">
      <div style="display:inline-block;background:#34c759;color:#fff;padding:6px 12px;border-radius:20px;font-weight:700;margin-bottom:14px;font-size:13px;">APPROVED ‚úÖ</div>

      <h2 style="font-size:18px;margin:6px 0 8px 0;">Hello ${data.name},</h2>
      <br><p style="font-size:15px;color:#111;line-height:1.45;margin:0 0 12px 0;">
        Great news ‚Äî your iDevice claim has been approved and is ready for the next steps.
      </p>

      <!-- Product Details Section -->
      <div style="background:#f5f5f7;padding:12px;border-radius:10px;margin:12px 0;font-size:14px;color:#111;">
        <div style="display:flex;gap:12px;align-items:flex-start;">
          <img src="${p.image}" alt="${p.title}" style="width:120px;height:90px;object-fit:cover;border-radius:8px;">
          <div style="flex:1">
            <h3 style="margin:0 0 8px 0;font-size:16px;">${p.title}</h3>
            <p style="margin:0 0 8px 0;color:#333;font-size:14px;">${p.description}</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:13px;">
              <div><strong>Color:</strong> ${data.color || p.color}</div>
              <div><strong>Storage:</strong> ${data.storage || p.storage}</div>
              <div><strong>Price:</strong> ${p.price}</div>
              <div><strong>Quantity:</strong> ${data.qty}</div>
            </div>
          </div>
        </div>
      </div>

      <div style="background:#f5f5f7;padding:12px;border-left:4px solid #0071e3;border-radius:10px;margin:12px 0;font-size:14px;color:#111;">
        <strong style="display:block;margin-bottom:8px;font-size:15px;">üìã Claim Details</strong>
        <div>üÜî <strong>Claim ID:</strong> ${data.claimId}</div>
        <div>üë§ <strong>Customer:</strong> ${data.name}</div>
        <div>üì± <strong>Device:</strong> ${p.title}</div>
        <div>‚è∞ <strong>Valid For:</strong> 72 hours</div>
        <div>üéØ <strong>Status:</strong> Approved & Ready</div>
      </div>

      <!-- New instruction before CTA -->

  <div style="font-weight:500;color:#111;margin-bottom:4px;"><br>iDevice Activation Required</div>

      <p style="font-size:14px;color:#333;margin:0 0 10px 0;">
        <strong>Next Step:</strong> Copy your Claim ID <strong>[${data.claimId}]</strong> and send it using the button below to activate your claim for delivery.
      </p>
      <div style="text-align:center;margin:16px 0;">
        <a href="https://wa.me/qr/GMUIPAULE4VQM1" style="display:inline-block;background:#0071e3;color:#fff;padding:10px 18px;border-radius:10px;text-decoration:none;font-weight:700;font-size:15px;">
          Complete Activation Now
        </a>
        <p style="color:#d70015;font-size:13px;margin:10px 0 0 0;">‚ö° Valid for 72 hours. Please respond promptly.</p><br><br><br><br>
      </div>
    </div>

    <div style="padding:14px;text-align:center;background:#f5f5f7;color:#6b6b6b;font-size:12px;border-top:1px solid #e5e5e7;">
      <div> ShirazAppleStore | Digital Service Center | Shah Alam, Selangor.<br>+601119873046 (873719-X) Copyright ¬©2025</div>
      <div style="margin-top:10px;font-size:12px;color:#666;">
        <em>Privacy:</em> We never sell your data.</div>
    </div>
  </div>
</div>
`.trim();
}

function generateSummary(){
  const data = {
    name: esc(document.getElementById('name').value),
    email: esc(document.getElementById('email').value),
    phone: esc(document.getElementById('phone').value),
    address: esc(document.getElementById('address').value),
    product: document.getElementById('product').value,
    color: esc(document.getElementById('color').value),
    storage: esc(document.getElementById('storage').value),
    qty: esc(document.getElementById('qty').value),
    claimId: esc(document.getElementById('claim').value)
  };

  const a4 = buildA4Html(data);
  document.getElementById('preview').innerHTML = a4;
  
  // Generate and display email HTML
  const emailHtml = buildEmailHtml(data);
  document.getElementById('emailPreview').innerHTML = emailHtml;
  document.getElementById('emailHtml').value = emailHtml;
  
  // Store latest versions
  window.latestA4 = a4;
  window.latestEmailHtml = emailHtml;

  showToast('Summary & Email HTML generated successfully');
}

async function downloadPDF() {
    if (!window.latestA4) {
        showToast('Please generate summary first', '#d70015');
        generateSummary();
        return;
    }

    showToast('Generating PDF...', '#0071e3');
    
    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        tempDiv.style.top = '0';
        tempDiv.style.width = '794px';
        tempDiv.style.background = 'white';
        tempDiv.innerHTML = window.latestA4;
        document.body.appendChild(tempDiv);

        const canvas = await html2canvas(tempDiv, {
            scale: 2,
            useCORS: true,
            allowTaint: false
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
        
        const claimId = document.getElementById('claim').value || 'claim';
        pdf.save(`iDevice_Claim_${claimId}.pdf`);
        
        document.body.removeChild(tempDiv);
        showToast('PDF downloaded successfully!', '#059669');
        
    } catch (error) {
        console.error('PDF error:', error);
        showToast('PDF generation failed. Try Print Preview instead.', '#d70015');
    }
}

function openPrintModal() {
  if (!window.latestA4) {
    showToast('Please generate summary first', '#d70015');
    generateSummary();
    return;
  }
  
  const modal = document.getElementById('printModal');
  const modalContent = document.getElementById('printModalContent');
  
  modalContent.innerHTML = window.latestA4;
  modal.style.display = 'flex';
  showToast('Print preview opened');
}

function closePrintModal() {
  document.getElementById('printModal').style.display = 'none';
}

function printFromModal() {
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head><title>Print Document</title></head>
      <body>${window.latestA4}</body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
  closePrintModal();
}

/* Email Functions - FULLY WORKING */
async function copyEmailHtml(){
  if(!window.latestEmailHtml) { 
    generateSummary(); 
    return; 
  }
  
  const html = window.latestEmailHtml || document.getElementById('emailHtml').value;
  
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(html);
      showToast('Email HTML copied ‚Äî paste into compose', '#059669'); 
      return;
    }
  }catch(e){
    console.error('Clipboard API failed:', e);
  }
  
  // fallback
  try{
    const ta = document.createElement('textarea'); 
    ta.value = html; 
    ta.style.position='fixed'; 
    ta.style.left='-9999px';
    document.body.appendChild(ta); 
    ta.select();
    const ok = document.execCommand('copy'); 
    document.body.removeChild(ta);
    
    if(ok){ 
      showToast('Email HTML copied (fallback)', '#059669'); 
      return; 
    }
  }catch(e){
    console.error('execCommand failed:', e);
  }
  
  alert('Copy failed. Select and copy the HTML from the box manually.');
}

function copyEmailFromBox(){ 
  const ta=document.getElementById('emailHtml'); 
  ta.select(); 
  try{ 
    document.execCommand('copy'); 
    showToast('Copied from box', '#059669'); 
  }catch(e){ 
    alert('Copy failed. Select manually.'); 
  }
}

function downloadEML(){
  if(!window.latestEmailHtml) generateSummary();
  
  const to = document.getElementById('email').value || '';
  const subject = `iDevice Claim Approved - ${document.getElementById('claim').value || ''}`;
  const eml = `From: shirazstore@icloud.com
To: ${to}
Subject: ${subject}
MIME-Version: 1.0
Content-Type: text/html; charset=UTF-8

${window.latestEmailHtml || document.getElementById('emailHtml').value}`.trim();
  
  const blob = new Blob([eml], {type:'message/rfc822'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href=url; 
  a.download = `iDevice_Claim_${document.getElementById('claim').value || 'email'}.eml`;
  document.body.appendChild(a); 
  a.click(); 
  document.body.removeChild(a); 
  URL.revokeObjectURL(url);
  
  showToast('.eml downloaded', '#059669');
}

function openMail(){
  const to = document.getElementById('email').value || '';
  const subject = encodeURIComponent(`iDevice Claim Approved - ${document.getElementById('claim').value || ''}`);
  const body = encodeURIComponent(`Hello ${document.getElementById('name').value || ''},\n\nYour iDevice claim has been approved. Claim ID: ${document.getElementById('claim').value || ''}\n\nPaste the HTML version (copied from the generator) into your email client for full formatting.\n\nRegards,\nShiraz Store`);
  window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
}

// Close modal when clicking outside
document.getElementById('printModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closePrintModal();
  }
});

prefill();
</script>
</body>
</html>
